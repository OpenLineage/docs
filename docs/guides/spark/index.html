<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-guides/spark">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Using OpenLineage with Spark | OpenLineage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openlineage.io/docs/guides/spark"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Using OpenLineage with Spark | OpenLineage"><meta data-rh="true" name="description" content="Adapted from a blog post by Michael Collado"><meta data-rh="true" property="og:description" content="Adapted from a blog post by Michael Collado"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openlineage.io/docs/guides/spark"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/guides/spark" hreflang="en"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/guides/spark" hreflang="x-default"><link rel="alternate" type="application/json" href="/blog/feed.json" title="OpenLineage JSON Feed">






<script src="https://plausible.io/js/script.js" defer="defer" data-domain="openlineage.io"></script><link rel="stylesheet" href="/assets/css/styles.75dc865a.css">
<link rel="preload" href="/assets/js/runtime~main.7fa354ac.js" as="script">
<link rel="preload" href="/assets/js/main.cc26c501.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#f26522;color:#091E42" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Help chart the course of OpenLineage! The 2023 Ecosystem Survey is live and accepting responses. <a href="https://forms.gle/cPk3skNgnB4iab9H6">Submit yours today</a>.</div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/resources">Resources</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/ecosystem">Ecosystem</a><a class="navbar__item navbar__link" href="/community">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/OpenLineage/openlineage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">About OpenLineage</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/spec/object-model">Core Specification</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/client/java">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/integrations/about">Integrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/guides/about">Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/about">About These Guides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/airflow-quickstart">Getting Started with Airflow and OpenLineage+Marquez</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/guides/spark">Using OpenLineage with Spark</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/airflow-backfill-dags">Backfilling Airflow DAGs Using Marquez</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/dbt">Using Marquez with dbt</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/facets">Understanding and Using Facets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guides/airflow_proxy">Using the OpenLineage Proxy with Airflow</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/development/developing/">Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/releases/1_1_0">Releases</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Guides</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Using OpenLineage with Spark</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Using OpenLineage with Spark</h1><h4 class="anchor anchorWithStickyNavbar_LWe7" id="adapted-from-a-blog-post-by-michael-collado">Adapted from a <a href="https://openlineage.io/blog/openlineage-spark/" target="_blank" rel="noopener noreferrer">blog post</a> by Michael Collado<a href="#adapted-from-a-blog-post-by-michael-collado" class="hash-link" aria-label="Direct link to adapted-from-a-blog-post-by-michael-collado" title="Direct link to adapted-from-a-blog-post-by-michael-collado">​</a></h4><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>This guide was developed using an <strong>earlier version</strong> of this integration and may require modification for recent releases.</p></div></div><p>Adding OpenLineage to Spark is refreshingly uncomplicated, and this is thanks to Spark&#x27;s SparkListener interface. OpenLineage integrates with Spark by implementing SparkListener and collecting information about jobs executed inside a Spark application. To activate the listener, add the following properties to your Spark configuration in your cluster&#x27;s <code>spark-defaults.conf</code> file or, alternatively, add them to specific jobs on submission via the <code>spark-submit</code> command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spark.jars.packages     io.openlineage:openlineage-spark:0.3.+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.extraListeners    io.openlineage.spark.agent.OpenLineageSparkListener</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once activated, the listener needs to know where to report lineage events, as well as the namespace of your jobs. Add the following additional configuration lines to your <code>spark-defaults.conf</code> file or your Spark submission script:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spark.openlineage.host      {your.openlineage.host}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.openlineage.namespace {your.openlineage.namespace}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-spark-with-openlineage">Running Spark with OpenLineage<a href="#running-spark-with-openlineage" class="hash-link" aria-label="Direct link to Running Spark with OpenLineage" title="Direct link to Running Spark with OpenLineage">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3><ul><li>Docker Desktop</li><li>git</li><li>Google Cloud Service account  </li><li>Google Cloud Service account JSON key file</li></ul><p>Note: your Google Cloud account should have access to BigQuery and read/write access to your GCS bucket. Giving your key file an easy-to-remember name (bq-spark-demo.json) is recommended. Finally, if using macOS Monterey (macOS 12), port 5000 will have to be released by <a href="https://developer.apple.com/forums/thread/682332" target="_blank" rel="noopener noreferrer">disabling the AirPlay Receiver</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="instructions">Instructions<a href="#instructions" class="hash-link" aria-label="Direct link to Instructions" title="Direct link to Instructions">​</a></h3><p>Clone the OpenLineage project, navigate to the spark directory, and create a directory for your Google Cloud Service credentials:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/OpenLineage/OpenLineage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd integration/spark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p docker/notebooks/gcs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Copy your Google Cloud Service credentials file into that directory, then run:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This launches a Jupyter notebook with Spark as well as a Marquez API endpoint already installed to report lineage. Once the notebook server is up and running, you should see something like the following in the logs:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.014 NotebookApp] Jupyter Notebook 6.4.4 is running at:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.014 NotebookApp] http://082cb836f1ec:8888/?token=507af3cf9c22f627f6c5211d6861fe0804d9f7b19a93ca48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.014 NotebookApp]  or http://127.0.0.1:8888/?token=507af3cf9c22f627f6c5211d6861fe0804d9f7b19a93ca48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.015 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Copy the URL with 127.0.0.1 as the hostname from your own log (the token will be different from this one) and paste it into your browser window. You should have a blank Jupyter notebook environment ready to go.</p><p><img loading="lazy" alt="Jupyter notebook environment" src="data:image/png;base64,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" width="1226" height="377" class="img_ev3q"></p><p>Click on the notebooks directory, then click on the New button to create a new Python 3 notebook.</p><p><img loading="lazy" alt="Jupyter new notebook" src="/assets/images/jupyter_new_notebook-8c87401b0e3cb3258324aec74a9cc53d.png" width="1214" height="365" class="img_ev3q"></p><p>In the first cell in the window paste the below text. Update the GCP project and bucket names and the service account credentials file, then run the code:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from pyspark.sql import SparkSession</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import urllib.request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Download dependencies for BigQuery and GCS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc_jars = [&#x27;https://repo1.maven.org/maven2/com/google/cloud/bigdataoss/gcs-connector/hadoop3-2.1.1/gcs-connector-hadoop3-2.1.1-shaded.jar&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;https://repo1.maven.org/maven2/com/google/cloud/bigdataoss/bigquery-connector/hadoop3-1.2.0/bigquery-connector-hadoop3-1.2.0-shaded.jar&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;https://repo1.maven.org/maven2/com/google/cloud/spark/spark-bigquery-with-dependencies_2.12/0.22.2/spark-bigquery-with-dependencies_2.12-0.22.2.jar&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files = [urllib.request.urlretrieve(url)[0] for url in gc_jars]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Set these to your own project and bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project_id = &#x27;bq-openlineage-spark-demo&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcs_bucket = &#x27;bq-openlineage-spark-demo-bucket&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">credentials_file = &#x27;/home/jovyan/notebooks/gcs/bq-spark-demo.json&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark = (SparkSession.builder.master(&#x27;local&#x27;).appName(&#x27;openlineage_spark_test&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.jars&#x27;, &quot;,&quot;.join(files))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Install and set up the OpenLineage listener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.jars.packages&#x27;, &#x27;io.openlineage:openlineage-spark:0.3.+&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.extraListeners&#x27;, &#x27;io.openlineage.spark.agent.OpenLineageSparkListener&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.openlineage.host&#x27;, &#x27;http://marquez-api:5000&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.openlineage.namespace&#x27;, &#x27;spark_integration&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Configure the Google credentials and project id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.executorEnv.GCS_PROJECT_ID&#x27;, project_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.executorEnv.GOOGLE_APPLICATION_CREDENTIALS&#x27;, &#x27;/home/jovyan/notebooks/gcs/bq-spark-demo.json&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.hadoop.google.cloud.auth.service.account.enable&#x27;, &#x27;true&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.hadoop.google.cloud.auth.service.account.json.keyfile&#x27;, credentials_file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.hadoop.fs.gs.impl&#x27;, &#x27;com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystem&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&#x27;spark.hadoop.fs.AbstractFileSystem.gs.impl&#x27;, &#x27;com.google.cloud.hadoop.fs.gcs.GoogleHadoopFS&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .config(&quot;spark.hadoop.fs.gs.project.id&quot;, project_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .getOrCreate())</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Most of this is boilerplate for installing the BigQuery and GCS libraries in the notebook environment. This also sets the configuration parameters to tell the libraries what GCP project to use and how to authenticate with Google. The parameters specific to OpenLineage are the four already mentioned: <code>spark.jars.packages</code>, <code>spark.extraListeners</code>, <code>spark.openlineage.host</code>, <code>spark.openlineage.namespace</code>. Here, the host has been configured to be the <code>marquez-api</code> container started by Docker.</p><p>With OpenLineage configured, it&#x27;s time to get some data. The below code populates Spark DataFrames with data from two COVID-19 public data sets. Create a new cell in the notebook and paste the following: </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from pyspark.sql.functions import expr, col</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mask_use = spark.read.format(&#x27;bigquery&#x27;) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&#x27;parentProject&#x27;, project_id) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&#x27;table&#x27;, &#x27;bigquery-public-data:covid19_nyt.mask_use_by_county&#x27;) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .load() \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .select(expr(&quot;always + frequently&quot;).alias(&quot;frequent&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expr(&quot;never + rarely&quot;).alias(&quot;rare&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;county_fips_code&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opendata = spark.read.format(&#x27;bigquery&#x27;) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&#x27;parentProject&#x27;, project_id) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&#x27;table&#x27;, &#x27;bigquery-public-data.covid19_open_data.covid19_open_data&#x27;) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .load() \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .filter(&quot;country_name == &#x27;United States of America&#x27;&quot;) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .filter(&quot;date == &#x27;2021-10-31&#x27;&quot;) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .select(&quot;location_key&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expr(&#x27;cumulative_deceased/(population/100000)&#x27;).alias(&#x27;deaths_per_100k&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expr(&#x27;cumulative_persons_fully_vaccinated/(population - population_age_00_09)&#x27;).alias(&#x27;vaccination_rate&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            col(&#x27;subregion2_code&#x27;).alias(&#x27;county_fips_code&#x27;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">joined = mask_use.join(opendata, &#x27;county_fips_code&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">joined.write.mode(&#x27;overwrite&#x27;).parquet(f&#x27;gs://{gcs_bucket}/demodata/covid_deaths_and_mask_usage/&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Some background on the above: the <code>covid19_open_data</code> table is being filtered to include only U.S. data and data for Halloween 2021. The <code>deaths_per_100k</code> data point is being calculated using the existing <code>cumulative_deceased</code> and <code>population</code> columns and the <code>vaccination_rate</code> using the total population, subtracting the 0-9 year olds, since they were ineligible for vaccination at the time. For the <code>mask_use_by_county</code> data, &quot;rarely&quot; and &quot;never&quot; data are being combined into a single number, as are &quot;frequently&quot; and &quot;always.&quot; The columns selected from the two datasets are then stored in GCS.</p><p>Now, add a cell to the notebook and paste this line:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spark.read.parquet(f&#x27;gs://{gcs_bucket}/demodata/covid_deaths_and_mask_usage/&#x27;).count()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The notebook should print a warning and a stacktrace (probably a debug statement), then return a total of 3142 records.</p><p>Now that the pipeline is operational it is available for lineage collection.</p><p>The <code>docker-compose.yml</code> file that ships with the OpenLineage repo includes only the Jupyter notebook and the Marquez API. To explore the lineage visually, start up the Marquez web project. Without terminating the existing docker containers, run the following command in a new terminal:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --network spark_default -p 3000:3000 -e MARQUEZ_HOST=marquez-api -e MARQUEZ_PORT=5000 --link marquez-api:marquez-api marquezproject/marquez-web:0.19.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, open a new browser tab and navigate to http://localhost:3000, which should look like this:</p><p><img loading="lazy" alt="Marquez home" src="/assets/images/marquez_home-ccf31aaf028eb9759ef4aaa755d9236d.png" width="1688" height="1308" class="img_ev3q"></p><p>Note: the <code>spark_integration</code> namespace is automatically chosen because there are no other namespaces available. Three jobs are listed on the jobs page of the UI. They all start with <code>openlineage_spark_test</code>, which is the appName passed to the SparkSession when the first cell of the notebook was built. Each query execution or RDD action is represented as a distinct job and the name of the action is appended to the application name to form the name of the job. Clicking on the <code>openlineage_spark_test.execute_insert_into_hadoop_fs_relation_command</code> node calls up the lineage graph for our notebook:</p><p><img loading="lazy" alt="Marquez job graph" src="/assets/images/marquez_job_graph-36260e0e671598e72438cd665ba4d5bc.png" width="1687" height="1307" class="img_ev3q"></p><p>The graph shows that the <code>openlineage_spark_test.execute_insert_into_hadoop_fs_relation_command</code> job reads from two input datasets, <code>bigquery-public-data.covid19_nyt.mask_use_by_county</code> and <code>bigquery-public-data.covid19_open_data.covid19_open_data</code>, and writes to a third dataset, <code>/demodata/covid_deaths_and_mask_usage</code>. The namespace is missing from that third dataset, but the fully qualified name is <code>gs://&lt;your_bucket&gt;/demodata/covid_deaths_and_mask_usage</code>.</p><p>The bottom bar shows some interesting data that was collected from the Spark job. Dragging the bar up expands the view to offer a closer look.</p><p><img loading="lazy" alt="Marquez job facets" src="/assets/images/marquez_job_facets-e5cc2629f752104bfdecb0ad2836afd1.png" width="1687" height="1307" class="img_ev3q"></p><p>Two facets always collected from Spark jobs are the <code>spark_version</code> and the <code>spark.logicalPlan</code>. The first simply reports what version of Spark was executing, as well as the version of the openlineage-spark library. This is helpful for debugging job runs.</p><p>The second facet is the serialized optimized LogicalPlan Spark reports when the job runs. Spark’s query optimization can have dramatic effects on the execution time and efficiency of the query job. Tracking how query plans change over time can significantly aid in debugging slow queries or <code>OutOfMemory</code> errors in production.</p><p>Clicking on the first BigQuery dataset provides information about the data:</p><p><img loading="lazy" alt="Marquez BigQuery dataset" src="/assets/images/marquez_bigquery_dataset_latest-887043572deffb77cf49da306c59ba53.png" width="1686" height="1307" class="img_ev3q"></p><p>One can see the schema of the dataset as well as the datasource.</p><p>Similar information is available about the dataset written to in GCS:</p><p><img loading="lazy" alt="Marquez output dataset" src="/assets/images/marquez_output_dataset_latest-0c1d02f62be9e66720dfc33b85ccc851.png" width="1688" height="1307" class="img_ev3q"></p><p>As in the BigQuery dataset, one can see the output schema and the datasource — in this case, the <code>gs://</code> scheme and the name of the bucket written to.</p><p>In addition to the schema, one can also see a stats facet, reporting the number of output records and bytes as -1. </p><p>The VERSIONS tab on the bottom bar would display multiple versions if there were any (not the case here). Clicking on the version shows the same schema and statistics facets, but they are specific to the version selected.</p><p><img loading="lazy" alt="Marquez output dataset version" src="/assets/images/marquez_output_dataset_version-1e0e5b024d82bfa3d2bf4a7cf8222d6c.png" width="1687" height="1308" class="img_ev3q"></p><p>In production, this dataset would have many versions, as each time a job runs a new version of the dataset is created. This permits the tracking of changes to the statistics and schema over time, aiding in debugging slow jobs or data quality issues and job failures.</p><p>The final job in the UI is a HashAggregate job. This represents the <code>count()</code> method called at the end to show the number of records in the dataset. Rather than a <code>count()</code>, this could easily be a <code>toPandas()</code> call or some other job that reads and processes that data -- perhaps one that stores output back into GCS or updates a Postgres database, publishes a new model, etc. Regardless of where the output gets stored, the OpenLineage integration allows one to see the entire lineage graph, unifying datasets in object stores, relational databases, and more traditional data warehouses.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3><p>The Spark integration from OpenLineage offers users insights into graphs of datasets stored in object stores like S3, GCS, and Azure Blob Storage, as well as BigQuery and relational databases like Postgres. Now with support for Spark 3.1, OpenLineage offers visibility into more environments, such as Databricks, EMR, and Dataproc clusters.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/OpenLineage/docs/tree/main/docs/guides/spark.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/guides/airflow-quickstart"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Getting Started with Airflow and OpenLineage+Marquez</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/guides/airflow-backfill-dags"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Backfilling Airflow DAGs Using Marquez</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#running-spark-with-openlineage" class="table-of-contents__link toc-highlight">Running Spark with OpenLineage</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#instructions" class="table-of-contents__link toc-highlight">Instructions</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.7fa354ac.js"></script>
<script src="/assets/js/main.cc26c501.js"></script>
</body>
</html>