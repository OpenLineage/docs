<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-development/developing/spark/built_in_lineage">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Integrating with Spark extensions | OpenLineage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openlineage.io/docs/development/developing/spark/built_in_lineage"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Integrating with Spark extensions | OpenLineage"><meta data-rh="true" name="description" content="Feature available since 1.11."><meta data-rh="true" property="og:description" content="Feature available since 1.11."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openlineage.io/docs/development/developing/spark/built_in_lineage"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/development/developing/spark/built_in_lineage" hreflang="en"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/development/developing/spark/built_in_lineage" hreflang="x-default"><link rel="alternate" type="application/json" href="/blog/feed.json" title="OpenLineage JSON Feed">






<script src="https://plausible.io/js/script.js" defer="defer" data-domain="openlineage.io"></script>
<script src="js/google_analytics.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-QMTWMLMX4M" async></script><link rel="stylesheet" href="/assets/css/styles.f478b2db.css">
<link rel="preload" href="/assets/js/runtime~main.115b512c.js" as="script">
<link rel="preload" href="/assets/js/main.8fd2f602.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/resources">Resources</a><a class="navbar__item navbar__link" href="/ecosystem">Ecosystem</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/survey">Ecosystem Survey 2023</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/OpenLineage/openlineage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">About OpenLineage</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/spec/object-model">Core Specification</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/client/java/">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/integrations/about">Integrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/guides/about">Guides</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/development/developing/">Development</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/development/developing/">Developing With OpenLineage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing With OpenLineage&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/development/developing/python/setup">Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/development/developing/java/setup">Java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/development/developing/spark/setup">Spark</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/development/developing/spark/setup">Build</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/development/developing/spark/built_in_lineage">Integrating with Spark extensions</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/development/examples">Example Lineage Events</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/development/ol-proxy">OpenLineage Proxy</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/releases/1_13_1">Releases</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Development</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/development/developing/"><span itemprop="name">Developing With OpenLineage</span></a><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spark</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Integrating with Spark extensions</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Integrating with Spark extensions</h1></header><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Feature available since 1.11.</p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>To get even better lineage coverage for Spark extensions, we recommend implementing lineage extraction
directly within the extensions&#x27; code and this page contains documentation on that.</p></div></div><p>Spark ecosystem comes with a plenty of extensions that affect lineage extraction logic.
<code>spark-interfaces-scala</code> package contains Scala traits which can be implemented on the extension&#x27;s side to
generate high quality metadata for OpenLineage events.</p><p>In general, a mechanism works in a following way: </p><ul><li>Package <code>spark-interfaces-scala</code> is a simple and lightweight.
Its only purpose is to contain methods to generate OpenLineage model objects (like facets, datasets) programmatically
and interfaces&#x27; definitions (Scala traits) to expose lineage information from nodes of Spark logical plan.</li><li>Any extension that adds custom node to Spark logical plan can implement the interfaces.</li><li>Spark OpenLineage integration, when traversing logical plan tree, checks if its nodes implement
those interfaces and uses their methods to extract lineage metadata from those nodes.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="problem-definition">Problem definition<a href="#problem-definition" class="hash-link" aria-label="Direct link to Problem definition" title="Direct link to Problem definition">​</a></h2><p>OpenLineage Spark integration is based on <code>openlineage-spark-*.jar</code> library attached
to a running Spark job. The library traverses Spark logical plan on run state updates to generate
OpenLineage events. While traversing plan&#x27;s tree, the library extracts input and output datasets
as well as other interesting aspects of this particular job, run or datasets involved in the processing.
Extraction code for each node is contained within <code>openlineage-spark.jar</code>.</p><p>Two main issues with this approach are:</p><ul><li><p>Spark ecosystem comes with plenty of extensions and many of them add
custom nodes into the logical plan of the query executed.
These nodes need to be traversed and understood by <code>openlineage-spark</code> to
extract lineage out of them. This brings serious complexity to the code base. Not only OpenLineage
has to cover multiple Spark versions, but also each Spark version supports multiple versions of
multiple extensions.</p></li><li><p>Spark extensions know a lot of valuable metadata that can be published within OpenLineage events.
It makes sense to allow extensions publish facets on their own. This <a href="https://github.com/OpenLineage/OpenLineage/issues/167" target="_blank" rel="noopener noreferrer">issue</a>
contains great example of useful aspects that can be retrieved from Iceberg extension.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution">Solution<a href="#solution" class="hash-link" aria-label="Direct link to Solution" title="Direct link to Solution">​</a></h2><p>A remedy to the problems above is to migrate lineage extraction logic directly to
Spark <code>LogicalPlan</code> nodes. The advantages of this approach are:</p><ul><li><strong>One-to-one version matching</strong> - there is no further need for a single integration code to support
multiple versions of a Spark extension.</li><li><strong>Avoid breaking changes</strong> - this approach limits amount of upgrades that break integration between
<code>openlineage-spark</code> and other extensions, as lineage extraction code is directly put into extensions
codebase which assures that changes on the Spark extension side are not breaking it.</li></ul><p><code>spark-interfaces-scala</code> package contains traits that shall be implemented as well as extra utility
classes to let integrate OpenLineage within any Spark extension.</p><p>Package code should not be shipped with extension that implements traits. Dependency should be marked
as compile-only. Implementation of the code calling the methods should be responsible for providing
<code>spark-interfaces-scala</code> on the classpath.</p><p>Please note that this package as well as the traits should be considered experimental and may evolve
in the future. All the current logic has been put into <code>*.scala.v1</code> package. First, it is possible
we develop the same interfaces in Java. Secondly, in case of non-compatible changes,
we are going to release <code>v2</code> interfaces. We&#x27;re aiming to support different versions within spark
integration.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="extracting-lineage-from-plan-nodes">Extracting lineage from plan nodes<a href="#extracting-lineage-from-plan-nodes" class="hash-link" aria-label="Direct link to Extracting lineage from plan nodes" title="Direct link to Extracting lineage from plan nodes">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-easy-way---return-all-the-metadata-about-dataset">The easy way - return all the metadata about dataset<a href="#the-easy-way---return-all-the-metadata-about-dataset" class="hash-link" aria-label="Direct link to The easy way - return all the metadata about dataset" title="Direct link to The easy way - return all the metadata about dataset">​</a></h3><p>Spark optimized logical plan is a tree created of <code>LogicalPlan</code> nodes. Oftentimes, it is a Spark extension
internal class that implements <code>LogicalPlan</code> and becomes node within a tree. In this case, it is
reasonable to implement lineage extraction logic directly within that class.</p><p>Two interfaces have been prepared:</p><ul><li><code>io.openlineage.spark.builtin.scala.v1.InputLineageNode</code> with <code>getInputs</code> method,</li><li><code>io.openlineage.spark.builtin.scala.v1.OutputLineageNode</code> with <code>getOutputs</code> method.</li></ul><p>They return list of <code>InputDatasetWithFacets</code> and <code>OutputDatasetWithFacets</code> respectively. Each trait has methods
to expose dataset facets as well facets that relate to particular dataset only in the context of
current run, like amount of bytes read from a certain dataset.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-extracting-dataset-name-and-namespace-is-non-trivial">When extracting dataset name and namespace is non-trivial<a href="#when-extracting-dataset-name-and-namespace-is-non-trivial" class="hash-link" aria-label="Direct link to When extracting dataset name and namespace is non-trivial" title="Direct link to When extracting dataset name and namespace is non-trivial">​</a></h3><p>The simple approach is to let the extension provide dataset identifier containing <code>namespace</code> as <code>name</code>.
However, in some cases this can be cumbersome.
For example, within Spark&#x27;s codebase there are several nodes whose output dataset is
<code>DatasourceV2Relation</code> and extracting dataset&#x27;s <code>name</code> and <code>namespace</code> from such nodes includes
non-trivial logic. In such scenarios, it does not make sense to require an extension to re-implement
the logic already present within <code>spark-openlineage</code> code. To solve this, the traits introduce datasets
with delegates which don&#x27;t contain exact dataset identifier with name and namespace. Instead, they contain
pointer to other member of the plan where <code>spark-openlineage</code> should extract identifier from. </p><p>For this scenario, case classes <code>InputDatasetWithDelegate</code> and
<code>OutputDatasetWithDelegate</code> have been created. They allow assigning facets to a dataset, while
still letting other code to extract metadata for the same dataset. The classes contain <code>node</code> object
property which defines node within logical plan to contain more metadata about the dataset.
In other words, returning a delegate will make OpenLineage Spark integration extract lineage from
the delegate and enrich it with facets attached to a delegate.</p><p>An example implementation for <code>ReplaceIcebergData</code> node:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">override def getOutputs(context: OpenLineageContext): List[OutputDatasetWithFacets] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!table.isInstanceOf[DataSourceV2Relation]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      List()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      val relation = table.asInstanceOf[DataSourceV2Relation]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      val datasetFacetsBuilder: DatasetFacetsBuilder = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new OpenLineage.DatasetFacetsBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .lifecycleStateChange(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .openLineage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .newLifecycleStateChangeDatasetFacet(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              OpenLineage.LifecycleStateChangeDatasetFacet.LifecycleStateChange.OVERWRITE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // enrich dataset with additional facets like a dataset version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      DatasetVersionUtils.getVersionOf(relation) match {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case Some(version) =&gt; datasetFacetsBuilder.version(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .openLineage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .newDatasetVersionDatasetFacet(version)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case None =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // return output dataset while pointing that more dataset details shall be extracted from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // `relation` object.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      List(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputDatasetWithDelegate(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          relation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          datasetFacetsBuilder,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          new OpenLineage.OutputDatasetOutputFacetsBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-extension-implements-a-relation-within-standard-logicalrelation">When extension implements a relation within standard LogicalRelation<a href="#when-extension-implements-a-relation-within-standard-logicalrelation" class="hash-link" aria-label="Direct link to When extension implements a relation within standard LogicalRelation" title="Direct link to When extension implements a relation within standard LogicalRelation">​</a></h3><p>In this scenario, Spark extension is using standard <code>LogicalRelation</code> node within the logical plan.
However, the node may contain extension&#x27;s specific <code>relation</code> property which extends
<code>org.apache.spark.sql.sources.BaseRelation</code>. In this case, we allow <code>BaseRelation</code> implementation
to implement <code>io.openlineage.spark.builtin.scala.v1.LineageRelation</code> interface.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-extension-implements-a-provider-to-create-relations">When extension implements a provider to create relations<a href="#when-extension-implements-a-provider-to-create-relations" class="hash-link" aria-label="Direct link to When extension implements a provider to create relations" title="Direct link to When extension implements a provider to create relations">​</a></h3><p>An extension can contain implementation of <code>org.apache.spark.sql.sources.RelationProvider</code>
which again does not use any custom nodes within the logical plan, but provides classes to
create relations. To support this scenarion, <code>io.openlineage.spark.builtin.scala.v1.LineageDatasetProvider</code>
can be implemented. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-extension-uses-spark-datasource-v2-api">When extension uses Spark DataSource v2 API<a href="#when-extension-uses-spark-datasource-v2-api" class="hash-link" aria-label="Direct link to When extension uses Spark DataSource v2 API" title="Direct link to When extension uses Spark DataSource v2 API">​</a></h3><p>Some extensions rely on Spark DataSource V2 API and implement TableProvider, Table, ScanBuilder etc.
that are used within Spark to create <code>DataSourceV2Relation</code> instances.</p><p>A logical plan node <code>DataSourceV2Relation</code> contains <code>Table</code> field with a properties map of type
<code>Map&lt;String, String&gt;</code>. <code>openlineage-spark</code> uses this map to extract dataset information for lineage
event from <code>DataSourceV2Relation</code>. It is checking for the properties <code>openlineage.dataset.name</code> and
<code>openlineage.dataset.namespace</code>. If they are present, it uses them to identify a dataset. Please
be aware that namespace and name need to conform to <a href="https://github.com/OpenLineage/OpenLineage/blob/main/spec/Naming.md" target="_blank" rel="noopener noreferrer">naming convention</a>.</p><p>Properties can be also used to pass any dataset facet. For example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openlineage.dataset.facets.customFacet={&quot;property1&quot;: &quot;value1&quot;, &quot;property2&quot;: &quot;value2&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>will enrich dataset with <code>customFacet</code>:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;inputs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;namespace&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;facets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;customFacet&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;property1&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;property2&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;_producer&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;schema&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="column-level-lineage">Column Level Lineage<a href="#column-level-lineage" class="hash-link" aria-label="Direct link to Column Level Lineage" title="Direct link to Column Level Lineage">​</a></h2><p>Lineage is extracted from the optimized logical plan. The plan is a tree with the root being the output
dataset and leaves the input datasets. In order to collect column level lineage we need to track dependencies between input and output fields.</p><p>Each node within plan has to understand which input attributes it consumes and how they affect output attributes produced by the node.
Attribute fields within plan are identified by <code>ExprId</code>. In order to build column level lineage,
dependencies between input and output attributes for each plan&#x27;s node need to be identified.</p><p>In order to emit column level lineage from a given spark node, <code>io.openlineage.spark.builtin.scala.v1.ColumnLevelLineageNode</code>
trait has to be implemented. The trait should implement following methods</p><ul><li><code>def columnLevelLineageInputs(context: OpenLineageContext): List[DatasetFieldLineage]</code></li><li><code>def columnLevelLineageOutputs(context: OpenLineageContext): List[DatasetFieldLineage]</code></li><li><code>columnLevelLineageDependencies(context: OpenLineageContext): List[ExpressionDependency]</code></li></ul><p>First two methods are used to identify input and output fields as well as matching the fields
to expressions which use the fields. Returned field lineage can contain identifier, which is mostly
field name, but can also be represented by a delegate object pointing to expression where
the identifier shall be extracted from.</p><p><code>ExpressionDependency</code> allows matching, for each Spark plan node, input expressions onto output
expressions. Having all the inputs and outputs identified, as well as intermediate dependencies between
the expressions used, allow building column level lineage facet.</p><p>Code below contains an example of <code>ColumnLevelLineageNode</code> within Iceberg&#x27;s <code>MergeRows</code> class
that implements <code>MERGE INTO</code> for Spark 3.4:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">case class MergeRows(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchedOutputs: Seq[Seq[Seq[Expression]]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    notMatchedOutputs: Seq[Seq[Expression]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output: Seq[Attribute],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    child: LogicalPlan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) extends UnaryNode with ColumnLevelLineageNode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override def columnLevelLineageDependencies(context: OpenLineageContext): List[ExpressionDependency] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      val deps: ListBuffer[ExpressionDependency] = ListBuffer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // For each matched and not-matched outputs `ExpressionDependencyWithDelegate` is created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // This means for output expression id `attr.exprId.id`, `expr` node needs to be examined to </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // detect input expression ids. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      output.zipWithIndex.foreach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case (attr: Attribute, index: Int) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          notMatchedOutputs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .toStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .filter(exprs =&gt; exprs.size &gt; index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .map(exprs =&gt; exprs(index))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .foreach(expr =&gt; deps += ExpressionDependencyWithDelegate(OlExprId(attr.exprId.id), expr))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          matchedOutputs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .foreach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              matched =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                matched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  .toStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  .filter(exprs =&gt; exprs.size &gt; index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  .map(exprs =&gt; exprs(index))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  .foreach(expr =&gt; deps += ExpressionDependencyWithDelegate(OlExprId(attr.exprId.id), expr))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      deps.toList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override def columnLevelLineageInputs(context: OpenLineageContext): List[DatasetFieldLineage] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Delegates input field extraction to other logical plan node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      List(InputDatasetFieldFromDelegate(child))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override def columnLevelLineageOutputs(context: OpenLineageContext): List[DatasetFieldLineage] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // For each output attribute return its name and ExprId assigned to it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // We&#x27;re aiming for lineage traits to stay Spark version agnostic and don&#x27;t want to rely </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // on Spark classes. That&#x27;s why `OlExprId` is used to pass `ExprId`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      output.map(a =&gt; OutputDatasetField(a.name, OlExprId(a.exprId.id))).toList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Please note that <code>ExpressionDependency</code> can be extended in the future to contain more information
on how inputs were used to produce a certain output attribute.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/OpenLineage/docs/tree/main/docs/development/developing/spark/built_in_lineage.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/development/developing/spark/setup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Build</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/development/examples"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Example Lineage Events</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#problem-definition" class="table-of-contents__link toc-highlight">Problem definition</a></li><li><a href="#solution" class="table-of-contents__link toc-highlight">Solution</a></li><li><a href="#extracting-lineage-from-plan-nodes" class="table-of-contents__link toc-highlight">Extracting lineage from plan nodes</a><ul><li><a href="#the-easy-way---return-all-the-metadata-about-dataset" class="table-of-contents__link toc-highlight">The easy way - return all the metadata about dataset</a></li><li><a href="#when-extracting-dataset-name-and-namespace-is-non-trivial" class="table-of-contents__link toc-highlight">When extracting dataset name and namespace is non-trivial</a></li><li><a href="#when-extension-implements-a-relation-within-standard-logicalrelation" class="table-of-contents__link toc-highlight">When extension implements a relation within standard LogicalRelation</a></li><li><a href="#when-extension-implements-a-provider-to-create-relations" class="table-of-contents__link toc-highlight">When extension implements a provider to create relations</a></li><li><a href="#when-extension-uses-spark-datasource-v2-api" class="table-of-contents__link toc-highlight">When extension uses Spark DataSource v2 API</a></li></ul></li><li><a href="#column-level-lineage" class="table-of-contents__link toc-highlight">Column Level Lineage</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.115b512c.js"></script>
<script src="/assets/js/main.8fd2f602.js"></script>
</body>
</html>