<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-integrations/spark/extending">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Extending | OpenLineage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openlineage.io/docs/integrations/spark/extending"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Extending | OpenLineage"><meta data-rh="true" name="description" content="The Spark library is intended to support extension via custom implementations of a handful"><meta data-rh="true" property="og:description" content="The Spark library is intended to support extension via custom implementations of a handful"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openlineage.io/docs/integrations/spark/extending"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/integrations/spark/extending" hreflang="en"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/integrations/spark/extending" hreflang="x-default"><link rel="alternate" type="application/json" href="/blog/feed.json" title="OpenLineage JSON Feed">






<script src="https://plausible.io/js/script.js" defer="defer" data-domain="openlineage.io"></script>
<script src="js/google_analytics.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-QMTWMLMX4M" async></script><link rel="stylesheet" href="/assets/css/styles.f478b2db.css">
<link rel="preload" href="/assets/js/runtime~main.115b512c.js" as="script">
<link rel="preload" href="/assets/js/main.8c4a8773.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/resources">Resources</a><a class="navbar__item navbar__link" href="/ecosystem">Ecosystem</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/survey">Ecosystem Survey 2023</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/OpenLineage/openlineage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">About OpenLineage</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/spec/object-model">Core Specification</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/client/java/">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/integrations/about">Integrations</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/about">OpenLineage Integrations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/integrations/spark/">Apache Spark</a><button aria-label="Toggle the collapsible sidebar category &#x27;Apache Spark&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/main_concept">Main Concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/integrations/spark/configuration/usage">Configuration</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/installation">Installation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/integrations/spark/quickstart/quickstart_local">Quickstart</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/spark_column_lineage">Column-Level Lineage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/integrations/spark/extending">Extending</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/job-hierarchy">Job Hierarchy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/metrics">Spark Integration Metrics</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/integrations/airflow/">Apache Airflow</a><button aria-label="Toggle the collapsible sidebar category &#x27;Apache Airflow&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/flink">Apache Flink</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/dbt">dbt</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/great-expectations">Great Expectations</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/guides/about">Guides</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/development/developing/">Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/releases/1_13_1">Releases</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Integrations</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/integrations/spark/"><span itemprop="name">Apache Spark</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Extending</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Extending</h1></header><p>The Spark library is intended to support extension via custom implementations of a handful
of interfaces. Nearly every extension interface extends or mimics Scala&#x27;s <code>PartialFunction</code>. The
<code>isDefinedAt(Object x)</code> method determines whether a given input is a valid input to the function.
A default implementation of <code>isDefinedAt(Object x)</code> is provided, which checks the generic type
arguments of the concrete class, if concrete type arguments are given, and determines if the input
argument matches the generic type. For example, the following class is automatically defined for an
input argument of type <code>MyDataset</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class MyDatasetDetector extends QueryPlanVisitor&lt;MyDataset, OutputDataset&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="api">API<a href="#api" class="hash-link" aria-label="Direct link to API" title="Direct link to API">​</a></h2><p>The following APIs are still evolving and may change over time based on user feedback.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="openlineageeventhandlerfactory"><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/OpenLineageEventHandlerFactory.java" target="_blank" rel="noopener noreferrer"><code>OpenLineageEventHandlerFactory</code></a><a href="#openlineageeventhandlerfactory" class="hash-link" aria-label="Direct link to openlineageeventhandlerfactory" title="Direct link to openlineageeventhandlerfactory">​</a></h3><p>This interface defines the main entrypoint to the extension codebase. Custom implementations
are registered by following Java&#x27;s <a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html" target="_blank" rel="noopener noreferrer"><code>ServiceLoader</code> conventions</a>.
A file called <code>io.openlineage.spark.api.OpenLineageEventHandlerFactory</code> must exist in the
application or jar&#x27;s <code>META-INF/service</code> directory. Each line of that file must be the fully
qualified class name of a concrete implementation of <code>OpenLineageEventHandlerFactory</code>. More than one
implementation can be present in a single file. This might be useful to separate extensions that
are targeted toward different environments - e.g., one factory may contain Azure-specific extensions,
while another factory may contain GCP extensions.</p><p>The <code>OpenLineageEventHandlerFactory</code> interface makes heavy use of default methods. Implementations
may override any or all of the following methods</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of QueryPlanVisitors that can generate InputDatasets from a LogicalPlan node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;PartialFunction&lt;LogicalPlan, List&lt;InputDataset&gt;&gt;&gt; createInputDatasetQueryPlanVisitors(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of QueryPlanVisitors that can generate OutputDatasets from a LogicalPlan node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;PartialFunction&lt;LogicalPlan, List&lt;OutputDataset&gt;&gt;&gt; createOutputDatasetQueryPlanVisitors(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of PartialFunctions that can generate InputDatasets from one of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * pre-defined Spark types accessible from SparkListenerEvents (see below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;PartialFunction&lt;Object, List&lt;InputDataset&gt;&gt;&gt; createInputDatasetBuilder(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of PartialFunctions that can generate OutputDatasets from one of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * pre-defined Spark types accessible from SparkListenerEvents (see below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;PartialFunction&lt;Object, List&lt;OutputDataset&gt;&gt;&gt; createOutputDatasetBuilder(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of CustomFacetBuilders that can generate InputDatasetFacets from one of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * pre-defined Spark types accessible from SparkListenerEvents (see below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;CustomFacetBuilder&lt;?, ? extends InputDatasetFacet&gt;&gt; createInputDatasetFacetBuilders(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of CustomFacetBuilders that can generate OutputDatasetFacets from one of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * pre-defined Spark types accessible from SparkListenerEvents (see below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;CustomFacetBuilder&lt;?, ? extends OutputDatasetFacet&gt;&gt;createOutputDatasetFacetBuilders(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of CustomFacetBuilders that can generate DatasetFacets from one of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * pre-defined Spark types accessible from SparkListenerEvents (see below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;CustomFacetBuilder&lt;?, ? extends DatasetFacet&gt;&gt; createDatasetFacetBuilders(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of CustomFacetBuilders that can generate RunFacets from one of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * pre-defined Spark types accessible from SparkListenerEvents (see below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;CustomFacetBuilder&lt;?, ? extends RunFacet&gt;&gt; createRunFacetBuilders(OpenLineageContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Return a collection of CustomFacetBuilders that can generate JobFacets from one of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * pre-defined Spark types accessible from SparkListenerEvents (see below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Collection&lt;CustomFacetBuilder&lt;?, ? extends JobFacet&gt;&gt; createJobFacetBuilders(OpenLineageContext context);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See the <a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/OpenLineageEventHandlerFactory.java" target="_blank" rel="noopener noreferrer"><code>OpenLineageEventHandlerFactory</code> javadocs</a>
for specifics on each method.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="queryplanvisitor"><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/QueryPlanVisitor.java" target="_blank" rel="noopener noreferrer"><code>QueryPlanVisitor</code></a><a href="#queryplanvisitor" class="hash-link" aria-label="Direct link to queryplanvisitor" title="Direct link to queryplanvisitor">​</a></h3><p>QueryPlanVisitors evaluate nodes of a Spark <code>LogicalPlan</code> and attempt to generate <code>InputDataset</code>s or
<code>OutputDataset</code>s from the information found in the <code>LogicalPlan</code> nodes. This is the most common
abstraction present in the OpenLineage Spark library, and many examples can be found in the
<code>io.openlineage.spark.agent.lifecycle.plan</code> package - examples include the
<a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/agent/lifecycle/plan/BigQueryNodeVisitor.java" target="_blank" rel="noopener noreferrer"><code>BigQueryNodeVisitor</code></a>,
the <a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/agent/lifecycle/plan/KafkaRelationVisitor.java" target="_blank" rel="noopener noreferrer"><code>KafkaRelationVisitor</code></a>
and the <a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/agent/lifecycle/plan/InsertIntoHiveTableVisitor.java" target="_blank" rel="noopener noreferrer"><code>InsertIntoHiveTableVisitor</code></a>.</p><p><code>QueryPlanVisitor</code>s implement Scala&#x27;s <code>PartialFunction</code> interface and are tested against every node
of a Spark query&#x27;s optimized <code>LogicalPlan</code>. Each invocation will expect either an <code>InputDataset</code>
or an <code>OutputDataset</code>. If a node can be either an <code>InputDataset</code> or an <code>OutputDataset</code>, the
constructor should accept a <code>DatasetFactory</code> so that the correct dataset type is generated at
runtime.</p><p><code>QueryPlanVisitor</code>s can attach facets to the Datasets created, e.g., <code>SchemaDatasetFacet</code> and
<code>DatasourceDatasetFacet</code> are typically attached to the dataset when it is created. Custom facets
can also be attached, though <code>CustomFacetBuilder</code>s <em>may</em> override facets attached directly to the
dataset.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="inputdatasetbuilder-and-outputdatasetbuilder"><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractInputDatasetBuilder.java" target="_blank" rel="noopener noreferrer"><code>InputDatasetBuilder</code></a> and <a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/common/java/io/openlineage/spark/api/AbstractOutputDatasetBuilder.java" target="_blank" rel="noopener noreferrer"><code>OutputDatasetBuilder</code></a><a href="#inputdatasetbuilder-and-outputdatasetbuilder" class="hash-link" aria-label="Direct link to inputdatasetbuilder-and-outputdatasetbuilder" title="Direct link to inputdatasetbuilder-and-outputdatasetbuilder">​</a></h3><p>Similar to the <code>QueryPlanVisitor</code>s, <code>InputDatasetBuilder</code>s and <code>OutputDatasetBuilder</code>s are
<code>PartialFunction</code>s defined for a specific input (see below for the list of Spark listener events and
scheduler objects that can be passed to a builder) that can generate either an <code>InputDataset</code> or an
<code>OutputDataset</code>. Though not strictly necessary, the abstract base classes
<a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractInputDatasetBuilder.java" target="_blank" rel="noopener noreferrer"><code>AbstractInputDatasetBuilder</code></a>
and <a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractOutputDatasetBuilder.java" target="_blank" rel="noopener noreferrer"><code>AbstractOutputDatasetBuilder</code></a>
are available for builders to extend.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="customfacetbuilder"><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/CustomFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>CustomFacetBuilder</code></a><a href="#customfacetbuilder" class="hash-link" aria-label="Direct link to customfacetbuilder" title="Direct link to customfacetbuilder">​</a></h3><p><code>CustomFacetBuilders</code> evaluate Spark event types and scheduler objects (see below) to construct custom
facets. <code>CustomFacetBuilders</code> are used to create <code>InputDatsetFacet</code>s, <code>OutputDatsetFacet</code>s,
<code>DatsetFacet</code>s, <code>RunFacet</code>s, and <code>JobFacet</code>s. A few examples can be found in the
<a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/agent/facets/builder" target="_blank" rel="noopener noreferrer"><code>io.openlineage.spark.agent.facets.builder</code></a>
package, including the <a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/agent/facets/builder/ErrorFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>ErrorFacetBuilder</code></a>
and the <a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/agent/facets/builder/LogicalPlanRunFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>LogicalPlanRunFacetBuilder</code></a>.
<code>CustomFacetBuilder</code>s are not <code>PartialFunction</code> implementations, but do define the <code>isDefinedAt(Object)</code>
method to determine whether a given input is valid for the function. They implement the <code>BiConsumer</code>
interface, accepting the valid input argument, and a <code>BiConsumer&lt;String, Facet&gt;</code> consumer, which
accepts the name and value of any custom facet that should be attached to the OpenLineage run.
There is no limit to the number of facets that can be reported by a given <code>CustomFacetBuilder</code>.
Facet names that conflict will overwrite previously reported facets if they are reported for the
same Spark event.
Though not strictly necessary, the following abstract base classes are available for extension:</p><ul><li><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractJobFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>AbstractJobFacetBuilder</code></a></li><li><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractRunFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>AbstractRunFacetBuilder</code></a></li><li><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractInputDatasetFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>AbstractInputDatasetFacetBuilder</code></a></li><li><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractOutputDatasetFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>AbstractOutputDatasetFacetBuilder</code></a></li><li><a href="https://github.com/OpenLineage/OpenLineage/blob/main/integration/spark/shared/src/main/java/io/openlineage/spark/api/AbstractDatasetFacetBuilder.java" target="_blank" rel="noopener noreferrer"><code>AbstractDatasetFacetBuilder</code></a></li></ul><p>Input/Output/Dataset facets returned are attached to <em>any</em> Input/Output Dataset found for a given
Spark event. Typically, a Spark job only has one <code>OutputDataset</code>, so any <code>OutputDatasetFacet</code>
generated will be attached to that <code>OutputDataset</code>. However, Spark jobs often have multiple
<code>InputDataset</code>s. Typically, an <code>InputDataset</code> is read within a single Spark <code>Stage</code>, and any metrics
pertaining to that dataset may be present in the <code>StageInfo#taskMetrics()</code> for that <code>Stage</code>.
Accumulators pertaining to a dataset should be reported in the task metrics for a stage so that the
<code>CustomFacetBuilder</code> can match against the <code>StageInfo</code> and retrieve the task metrics for that stage
when generating the <code>InputDatasetFacet</code>. Other facet information is often found by analyzing the
<code>RDD</code> that reads the raw data for a dataset. <code>CustomFacetBuilder</code>s that generate these facets should
be defined for the specific subclass of <code>RDD</code> that is used to read the target dataset - e.g.,
<code>HadoopRDD</code>, <code>BigQueryRDD</code>, or <code>JdbcRDD</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="function-argument-types">Function Argument Types<a href="#function-argument-types" class="hash-link" aria-label="Direct link to Function Argument Types" title="Direct link to Function Argument Types">​</a></h3><p><code>CustomFacetBuilder</code>s and dataset builders can be defined for the following set of Spark listener
event types and scheduler types:</p><ul><li><code>org.apache.spark.sql.execution.ui.SparkListenerSQLExecutionStart</code></li><li><code>org.apache.spark.sql.execution.ui.SparkListenerSQLExecutionEnd</code></li><li><code>org.apache.spark.scheduler.SparkListenerJobStart</code></li><li><code>org.apache.spark.scheduler.SparkListenerJobEnd</code></li><li><code>org.apache.spark.rdd.RDD</code></li><li><code>org.apache.spark.scheduler.Stage</code></li><li><code>org.apache.spark.scheduler.StageInfo</code></li><li><code>org.apache.spark.scheduler.ActiveJob</code></li></ul><p>Note that <code>RDD</code>s are &quot;unwrapped&quot; prior to being evaluated by builders, so there&#x27;s no need to, e.g.,
check a <code>MapPartitionsRDD</code>&#x27;s dependencies. The <code>RDD</code> for each <code>Stage</code> can be evaluated when a
<code>org.apache.spark.scheduler.SparkListenerStageCompleted</code> event occurs. When a
<code>org.apache.spark.scheduler.SparkListenerJobEnd</code> event is encountered, the last <code>Stage</code> for the
<code>ActiveJob</code> can be evaluated.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spark-extensions-built-in-lineage-extraction">Spark extensions&#x27; built-in lineage extraction<a href="#spark-extensions-built-in-lineage-extraction" class="hash-link" aria-label="Direct link to Spark extensions&#x27; built-in lineage extraction" title="Direct link to Spark extensions&#x27; built-in lineage extraction">​</a></h2><p>Spark ecosystem comes with a plenty of pluggable extensions like iceberg, delta or spark-bigquery-connector
to name a few. Extensions modify logical plan of the job and inject its own classes from which lineage shall be
extracted. This is adding extra complexity, as it makes <code>openlineage-spark</code> codebase
dependent on the extension packages. The complexity grows more when multiple versions
of the same extension need to be supported.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spark-datasource-v2-api-extensions">Spark DataSource V2 API Extensions<a href="#spark-datasource-v2-api-extensions" class="hash-link" aria-label="Direct link to Spark DataSource V2 API Extensions" title="Direct link to Spark DataSource V2 API Extensions">​</a></h3><p>Some extensions rely on Spark DataSource V2 API and implement TableProvider, Table, ScanBuilder etc.
that are used within Spark to create <code>DataSourceV2Relation</code> instances.</p><p>A logical plan node <code>DataSourceV2Relation</code> contains <code>Table</code> field with a properties map of type
<code>Map&lt;String, String&gt;</code>. <code>openlineage-spark</code> uses this map to extract dataset information for lineage
event from <code>DataSourceV2Relation</code>. It is checking for the properties <code>openlineage.dataset.name</code> and
<code>openlineage.dataset.namespace</code>. If they are present, it uses them to identify a dataset. Please
be aware that namespace and name need to conform to <a href="https://github.com/OpenLineage/OpenLineage/blob/main/spec/Naming.md" target="_blank" rel="noopener noreferrer">naming convention</a>.</p><p>Properties can be also used to pass any dataset facet. For example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openlineage.dataset.facets.customFacet={&quot;property1&quot;: &quot;value1&quot;, &quot;property2&quot;: &quot;value2&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>will enrich dataset with <code>customFacet</code>:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;inputs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;namespace&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;facets&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;customFacet&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;property1&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;property2&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;_producer&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;schema&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The approach can be used for standard facets
from OpenLineage spec as well. <code>schema</code> does not need to be passed through the properties as
it is derived within <code>openlineage-spark</code> from <code>DataSourceV2Relation</code>. Custom facets are automatically
filled with <code>_producer</code> field.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/OpenLineage/docs/tree/main/docs/integrations/spark/extending.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/integrations/spark/spark_column_lineage"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Column-Level Lineage</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/integrations/spark/job-hierarchy"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Job Hierarchy</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#api" class="table-of-contents__link toc-highlight">API</a><ul><li><a href="#openlineageeventhandlerfactory" class="table-of-contents__link toc-highlight"><code>OpenLineageEventHandlerFactory</code></a></li><li><a href="#queryplanvisitor" class="table-of-contents__link toc-highlight"><code>QueryPlanVisitor</code></a></li><li><a href="#inputdatasetbuilder-and-outputdatasetbuilder" class="table-of-contents__link toc-highlight"><code>InputDatasetBuilder</code> and <code>OutputDatasetBuilder</code></a></li><li><a href="#customfacetbuilder" class="table-of-contents__link toc-highlight"><code>CustomFacetBuilder</code></a></li><li><a href="#function-argument-types" class="table-of-contents__link toc-highlight">Function Argument Types</a></li></ul></li><li><a href="#spark-extensions-built-in-lineage-extraction" class="table-of-contents__link toc-highlight">Spark extensions&#39; built-in lineage extraction</a><ul><li><a href="#spark-datasource-v2-api-extensions" class="table-of-contents__link toc-highlight">Spark DataSource V2 API Extensions</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.115b512c.js"></script>
<script src="/assets/js/main.8c4a8773.js"></script>
</body>
</html>