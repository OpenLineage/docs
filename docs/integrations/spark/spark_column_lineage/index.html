<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-integrations/spark/spark_column_lineage">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Column-Level Lineage | OpenLineage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openlineage.io/docs/integrations/spark/spark_column_lineage"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Column-Level Lineage | OpenLineage"><meta data-rh="true" name="description" content="Column-level lineage works only with Spark 3."><meta data-rh="true" property="og:description" content="Column-level lineage works only with Spark 3."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openlineage.io/docs/integrations/spark/spark_column_lineage"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/integrations/spark/spark_column_lineage" hreflang="en"><link data-rh="true" rel="alternate" href="https://openlineage.io/docs/integrations/spark/spark_column_lineage" hreflang="x-default"><link rel="alternate" type="application/json" href="/blog/feed.json" title="OpenLineage JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QMTWMLMX4M"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-QMTWMLMX4M",{anonymize_ip:!0})</script>





<script src="https://plausible.io/js/script.js" defer="defer" data-domain="openlineage.io"></script><link rel="stylesheet" href="/assets/css/styles.c2b42416.css">
<link rel="preload" href="/assets/js/runtime~main.b5154007.js" as="script">
<link rel="preload" href="/assets/js/main.749dbf33.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/resources">Resources</a><a class="navbar__item navbar__link" href="/ecosystem">Ecosystem</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/survey">Ecosystem Survey 2023</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/OpenLineage/openlineage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">About OpenLineage</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/spec/object-model">Core Specification</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/client/java/">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/integrations/about">Integrations</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/about">OpenLineage Integrations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/integrations/spark/">Apache Spark</a><button aria-label="Toggle the collapsible sidebar category &#x27;Apache Spark&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/main_concept">Main Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/installation">Installation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/integrations/spark/configuration/usage">Configuration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/integrations/spark/quickstart/quickstart_local">Quickstart</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/job-hierarchy">Job Hierarchy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/integrations/spark/spark_column_lineage">Column-Level Lineage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/metrics">Spark Integration Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/spark/extending">Extending</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/integrations/airflow/">Apache Airflow</a><button aria-label="Toggle the collapsible sidebar category &#x27;Apache Airflow&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/flink">Apache Flink</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/dbt">dbt</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/great-expectations">Great Expectations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/integrations/trino">Trino</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/guides/about">Guides</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/development/developing/">Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/releases/1_19_0">Releases</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Integrations</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/integrations/spark/"><span itemprop="name">Apache Spark</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Column-Level Lineage</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Column-Level Lineage</h1></header><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Column-level lineage works only with Spark 3.</p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Column-level lineage for Spark is turned on by default and requires no additional work to be done. The following documentation describes its internals. </p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Lineage contains information about what fields were used to create of influence the field but also how, see <a href="/docs/spec/facets/dataset-facets/column_lineage_facet#transformation-type">Transformation Types</a></p></div></div><p>Column-level lineage provides fine-grained information on datasets dependencies. Not only do we know the dependency exists, but we are also able to understand which input columns are used to produce output columns. This allows for answering questions like <em>Which root input columns are used to construct column x?</em> </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="standard-specification">Standard specification<a href="#standard-specification" class="hash-link" aria-label="Direct link to Standard specification" title="Direct link to Standard specification">​</a></h2><p>Collected information is sent in OpenLineage event within <code>columnLineage</code> dataset facet described <a href="/docs/spec/facets/dataset-facets/column_lineage_facet">here</a>. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-architecture-and-its-mechanics">Code architecture and its mechanics<a href="#code-architecture-and-its-mechanics" class="hash-link" aria-label="Direct link to Code architecture and its mechanics" title="Direct link to Code architecture and its mechanics">​</a></h2><p>Column-level lineage has been implemented separately from the rest of builders and visitors extracting lineage information from Spark logical plans. As a result the codebase is stored in <code>io.openlineage.spark3.agent.lifecycle.plan.columnLineage</code> package within classes responsible only for this feature.</p><ul><li><p>Class <code>ColumnLevelLineageUtils.java</code> is an entry point to run the mechanism and is used within <code>OpenLineageRunEventBuilder</code>.</p></li><li><p>Classes <code>ColumnLevelLineageUtilsNonV2CatalogTest</code> and <code>ColumnLevelLineageUtilsV2CatalogTest</code> contain real-life test cases which run Spark jobs and get an access to the last query plan executed.
They evaluate column-level lineage based on the plan and expected output schema.
Then, they verify if this meets the requirements.
This allows testing column-level lineage behavior in real scenarios. The more tests and scenarios put here, the better.</p></li><li><p>Class <code>ColumnLevelLineageBuilder</code> contains both the logic of building output facet (<code>ColumnLineageDatasetFacetFields</code>)
and datastructures containing necessary information:</p><ul><li>schema - <code>SchemaDatasetFacet</code> contains information about output schema </li><li>inputs - map pointing from <code>ExprId</code> to column name and <code>DatasetIdentifier</code> identifying the datasource </li><li>outputs - map pointing from output field name to its <code>ExprId</code></li><li>exprDependencies - map pointing from <code>ExprId</code> to set of its <code>Dependency</code> objects containing <code>ExprId</code> and information about type of the dependency.</li><li>datasetDependencies - list of <code>ExprId</code> representing pseudo-expressions representing operations like <code>filter</code>, <code>join</code> etc.</li><li>externalExpressionMappings - map poiting from <code>ColumnMeta</code> object to <code>ExprId</code> used for dependencies extracted by <code>sql-parser</code></li></ul></li></ul><ul><li><p>Class <code>ColumnLevelLineageBuilder</code> is used when traversing logical plans to store all the information required to produce column-level lineage.
It allows storing input/output columns. It also stores dependencies between the expressions contained in query plan.
Once inputs, outputs and dependencies are filled, build method is used to produce output facet (<code>ColumnLineageDatasetFacetFields</code>).</p></li><li><p><code>OutputFieldsCollector</code> class is used to traverse the plan to gather the <code>outputs</code>,
even though the information about output dataset is already in <code>schema</code>, it&#x27;s not coupled information about the outputs <code>ExprId</code>.
The collector traverses the plan and matches the outputs existing there, inside <code>Aggregate</code> or <code>Project</code> objects, with the ones in <code>schema</code> by their name.</p></li><li><p><code>InputFieldsCollector</code> class is used to collect the inputs which can be extracted from <code>DataSourceV2Relation</code>, <code>DataSourceV2ScanRelation</code>, <code>HiveTableRelation</code> or <code>LogicalRelation</code>.
Each input field has its <code>ExprId</code> within the plan. Each input is identified by <code>DatasetIdentifier</code>, which means it contains name and namespace, of a dataset and an input field.</p></li><li><p><code>ExpressionDependenciesCollector</code> traverses the plan to identify dependencies between different expressions using their <code>ExprId</code>. Dependencies map parent expressions to its dependencies with additional information about the transformation type.
This is used evaluate which inputs influenced certain output and what kind of influence was it.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expression-dependency-collection-process">Expression dependency collection process<a href="#expression-dependency-collection-process" class="hash-link" aria-label="Direct link to Expression dependency collection process" title="Direct link to Expression dependency collection process">​</a></h3><p>For each node in <code>LogicalPlan</code> the <code>ExpressionDependencyCollector</code> attempts to extract the column lineage information based on its type.
First it goes through <code>ColumnLineageVisitors</code> to check if any applies to current node, if so then it extract dependencies from them.
Next if the node is <code>LogicalRelation</code> and relation type is <code>JDBCRelation</code>, the sql-parser extracts lineage data from query string itself.</p><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Because Sql parser only parses the query string in <code>JDBCRelation</code> it does not collect information about input field types or transformation types.
The only info collected is the name of the table/view and field, as it is mentioned in the query.</p></div></div><p>After that all that&#x27;s left are following types of nodes: <code>Project</code>,<code>Aggregate</code>, <code>Join</code>, <code>Filter</code>, <code>Sort</code>.
Each of them contains dependency expressions that can be added to one of the lists <code>expressions</code> or <code>datasetDependencies</code>.</p><p>When node is <code>Aggregate</code>, <code>Join</code>, <code>Filter</code> or <code>Sort</code> it contains dependencies that don&#x27;t affect one single output but all the outputs,
so they need to be treated differently than normal dependencies.
For each of those nodes the new <code>ExprId</code> is created to represent &quot;all outputs&quot;, all its dependencies will be of <code>INDIRECT</code> type.</p><p>For each of the <code>expressions</code> the collector tries to go through it and possible children expressions and add them to <code>exprDependencies</code> map with appropriate transformation type and <code>masking</code> flag.
Most of the expressions represent <code>DIRECT</code> transformation, only exceptions are <code>If</code> and <code>CaseWhen</code> which contain condition expressions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="facet-building-process">Facet building process<a href="#facet-building-process" class="hash-link" aria-label="Direct link to Facet building process" title="Direct link to Facet building process">​</a></h3><p>For each of the outputs <code>ColumnLevelLineageBuilder</code> goes through the <code>exprDependencies</code> to build the list final dependencies, then using <code>inputs</code> maps them to fields in datasets.
During the process it also unravels the transformation type between the input and output.
To unravel two dependencies implement following logic:</p><ul><li>if current type is <code>INDIRECT</code> the result takes the type and subtype from current</li><li>if current type is <code>DIRECT</code> and other one is null, result is null</li><li>if current type is <code>DIRECT</code> and other is <code>INDIRECT</code> the result takes type and subtype from other</li><li>if both are <code>DIRECT</code> the result is type <code>DIRECT</code>, subtype is the first existing from the order <code>AGGREGATION</code>, <code>TRANSFORMATION</code>, <code>IDENTITY</code></li><li>if any of the transformations is masking, the result is masking</li></ul><p>The inputs are also mapped for all dataset dependencies. The result is added to each output.
Finally, the list of outputs with all their inputs is mapped to <code>ColumnLineageDatasetFacetFields</code> object.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="writing-custom-extensions">Writing custom extensions<a href="#writing-custom-extensions" class="hash-link" aria-label="Direct link to Writing custom extensions" title="Direct link to Writing custom extensions">​</a></h2><p>Spark framework is known for its great ability to be extended by custom libraries capable of reading or writing to anything. In case of having a custom implementation, we prepared an ability to extend column-level lineage implementation to be able to retrieve information from other input or output LogicalPlan nodes. </p><p>Creating such an extension requires implementing a following interface: </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/** Interface for implementing custom collectors of column-level lineage. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface CustomColumnLineageVisitor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Collect inputs for a given {@link LogicalPlan}. Column-level lineage mechanism traverses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * LogicalPlan on its node. This method will be called for each traversed node. Input information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * should be put into builder.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void collectInputs(LogicalPlan node, ColumnLevelLineageBuilder builder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Collect outputs for a given {@link LogicalPlan}. Column-level lineage mechanism traverses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * LogicalPlan on its node. This method will be called for each traversed node. Output information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * should be put into builder.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void collectOutputs(LogicalPlan node, ColumnLevelLineageBuilder builder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Collect expressions for a given {@link LogicalPlan}. Column-level lineage mechanism traverses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * LogicalPlan on its node. This method will be called for each traversed node. Expression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * dependency information should be put into builder.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void collectExpressionDependencies(LogicalPlan node, ColumnLevelLineageBuilder builder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and making it available for Service Loader (implementation class name has to be put in a resource file <code>META-INF/services/io.openlineage.spark.agent.lifecycle.plan.column.CustomColumnLineageVisitor</code>).</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/OpenLineage/docs/tree/main/docs/integrations/spark/spark_column_lineage.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/integrations/spark/job-hierarchy"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Job Hierarchy</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/integrations/spark/metrics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spark Integration Metrics</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#standard-specification" class="table-of-contents__link toc-highlight">Standard specification</a></li><li><a href="#code-architecture-and-its-mechanics" class="table-of-contents__link toc-highlight">Code architecture and its mechanics</a><ul><li><a href="#expression-dependency-collection-process" class="table-of-contents__link toc-highlight">Expression dependency collection process</a></li><li><a href="#facet-building-process" class="table-of-contents__link toc-highlight">Facet building process</a></li></ul></li><li><a href="#writing-custom-extensions" class="table-of-contents__link toc-highlight">Writing custom extensions</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.b5154007.js"></script>
<script src="/assets/js/main.749dbf33.js"></script>
</body>
</html>