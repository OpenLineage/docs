<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Tracing Data Lineage with OpenLineage and Apache Spark | OpenLineage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openlineage.io/blog/openlineage-spark"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Tracing Data Lineage with OpenLineage and Apache Spark | OpenLineage"><meta data-rh="true" name="description" content="Spark ushered in a brand new age of data democratization... and left us with a mess of hidden dependencies, stale datasets, and failed jobs."><meta data-rh="true" property="og:description" content="Spark ushered in a brand new age of data democratization... and left us with a mess of hidden dependencies, stale datasets, and failed jobs."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-11-05T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.github.com/collado-mike"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openlineage.io/blog/openlineage-spark"><link data-rh="true" rel="alternate" href="https://openlineage.io/blog/openlineage-spark" hreflang="en"><link data-rh="true" rel="alternate" href="https://openlineage.io/blog/openlineage-spark" hreflang="x-default"><link rel="alternate" type="application/json" href="/blog/feed.json" title="OpenLineage JSON Feed">






<script src="https://plausible.io/js/script.js" defer="defer" data-domain="openlineage.io"></script>
<script src="js/google_analytics.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-QMTWMLMX4M" async></script><link rel="stylesheet" href="/assets/css/styles.e2913961.css">
<link rel="preload" href="/assets/js/runtime~main.53847bfe.js" as="script">
<link rel="preload" href="/assets/js/main.3eff26fa.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/resources">Resources</a><a class="navbar__item navbar__link" href="/ecosystem">Ecosystem</a><a class="navbar__item navbar__link" href="/community">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/survey">Ecosystem Survey 2023</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/OpenLineage/openlineage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/boston-collibra-meetup">Join us in Boston on March 19th</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kafka-summit-talk">OpenLineage Support for Streaming to Feature at Kafka Summit</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/london-confluent-meetup">Join us in London on January 31st</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/warsaw-meetup">Meet Us in Warsaw on November 29th!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/metaphor-integration">Metaphor&#x27;s Integration with OpenLineage Enhances Data Governance and Collaboration</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Tracing Data Lineage with OpenLineage and Apache Spark</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-11-05T00:00:00.000Z" itemprop="datePublished">November 5, 2021</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.github.com/collado-mike" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://www.github.com/collado-mike.png" alt="Michael Collado"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.github.com/collado-mike" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Michael Collado</span></a></div><small class="avatar__subtitle" itemprop="description">OpenLineage Committer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Spark ushered in a brand new age of data democratization... and left us with a mess of hidden dependencies, stale datasets, and failed jobs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-age-of-data-democratization">The Age of Data Democratization<a href="#the-age-of-data-democratization" class="hash-link" aria-label="Direct link to The Age of Data Democratization" title="Direct link to The Age of Data Democratization">​</a></h2><p>In 2015, Apache Spark seemed to be taking over the world. Many of us had spent the prior few years moving our large
datasets out of the Data Warehouse into &quot;Data Lakes&quot;- repositories of structured and unstructured data in
distributed file systems or object stores, like HDFS or S3. This enabled us to build analytic systems that could
handle traditional, table-structured data alongside flexible, unstructured JSON blobs, giving us access to more data
and allowing us to move much faster than we’d previously been able to.</p><p>The problem was that taking the data out of Data Warehouses meant that the people who really needed access to the
data, analysts and statisticians, could no longer use the tools they were comfortable with in order to read that data.
Where previously, SQL and Python were all that was needed to start exploring and analyzing a dataset, now people needed
to write Java or use specialized scripting languages, like Pig, to get at the data. Systems that did support SQL, such
as Hive, were unbearably slow for any but the most basic operations. In many places, the statisticians were dependent on
software engineers to build custom tools for access, meaning the bottleneck had moved from the systems that
needed to store and process the data to the humans who were supposed to tell us what systems to build.</p><p>Then along came Apache Spark, which gave back to analysts the ability to use their beloved Python (and eventually SQL)
tools to process raw data in object stores without the dependency on software engineers. While others were
attracted to its ability to perform multiple operations on data without the I/O overhead of alternatives, like Pig or
Hive, data scientists were thrilled to start piping that data through their NumPy and Pandas scripts. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-colossal-mess">A Colossal Mess<a href="#a-colossal-mess" class="hash-link" aria-label="Direct link to A Colossal Mess" title="Direct link to A Colossal Mess">​</a></h2><p>Of course, the natural consequence of this data democratization is that it becomes difficult to keep track of who is
using the data and for what purpose. Hidden dependencies and Hyrum’s Law suddenly meant that changes to the data schema
would inadvertently break downstream processes or that stale, deprecated datasets were still being consumed, and that
corrupted datasets would leak into unknown processes making recovery difficult or even impossible.</p><p><a href="https://xkcd.com/1172/" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="XKCD 1172" src="/assets/images/workflow-60bcdebaee424553b3c757b62de0a1fe.png" width="278" height="386" class="img_ev3q"></a></p><p>The goal of OpenLineage is to reduce issues and speed up recovery by exposing those hidden dependencies and informing
both producers and consumers of data about the state of that data and the potential blast radius of changes and software
bugs. Naturally, support for Apache Spark seemed like a good idea and, while the Spark 2.4 branch has been supported for
some time, the recent OpenLineage 0.3 release has explicit support for Spark 3.1. 🎉 </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started">Getting Started<a href="#getting-started" class="hash-link" aria-label="Direct link to Getting Started" title="Direct link to Getting Started">​</a></h2><p>Our approach to integrating with Spark is not super novel nor is it complicated to integrate into your own system. Spark
has had a SparkListener interface since before the 1.x days. If you&#x27;re a heavy Spark user, it&#x27;s likely you&#x27;re already
familiar with it and how it&#x27;s used in Spark applications. OpenLineage integrates with Spark by implementing that
interface and collecting information about jobs that are executed inside a Spark application. To activate the
listener, add the following properties to your Spark configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spark.jars.packages     io.openlineage:openlineage-spark:0.3.+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.extraListeners    io.openlineage.spark.agent.OpenLineageSparkListener</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This can be added to your cluster’s <code>spark-defaults.conf</code> file, in which case it will record lineage for every job executed on the cluster, or added to specific jobs on submission via the <code>spark-submit</code> command. Once the listener is activated, it needs to know where to report lineage events, as well as the namespace of your jobs. Add the following additional configuration lines to your <code>spark-defaults.conf</code> file or your Spark submission script:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spark.openlineage.transport.url     {your.openlineage.url}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.openlineage.transport.type    &#x27;http&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.openlineage.namespace         {your.openlineage.namespace}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-demo">The Demo<a href="#the-demo" class="hash-link" aria-label="Direct link to The Demo" title="Direct link to The Demo">​</a></h2><p>Trying out the Spark integration is super easy if you already have Docker Desktop and git installed. To follow along
with this demo, you’ll also need a Google Cloud account and a Service Account JSON key file for an account that has
access to BigQuery and read/write access to your GCS bucket. I added mine to a file called bq-spark-demo.json.</p><p>Note: If you&#x27;re on macOS Monterey (macOS 12) you&#x27;ll have to release port 5000 before beginning by <a href="https://developer.apple.com/forums/thread/682332" target="_blank" rel="noopener noreferrer">disabling the AirPlay Receiver</a>.</p><p>Check out the OpenLineage project into your workspace with:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/OpenLineage/OpenLineage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then cd into the integration/spark directory. Run <code>mkdir -p docker/notebooks/gcs</code> and copy your service account credentials
file into that directory. Then run:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker-compose</span><span class="token plain"> up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This launches a Jupyter notebook with Spark already installed as well as a Marquez API endpoint to report lineage. Once the notebook server is up and running, you should see something like the following text in the logs:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.014 NotebookApp] Jupyter Notebook 6.4.4 is running at:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.014 NotebookApp] http://082cb836f1ec:8888/?token=507af3cf9c22f627f6c5211d6861fe0804d9f7b19a93ca48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.014 NotebookApp]  or http://127.0.0.1:8888/?token=507af3cf9c22f627f6c5211d6861fe0804d9f7b19a93ca48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notebook_1  | [I 21:43:39.015 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Copy the URL with 127.0.0.1 as the hostname from your own log (the token will be different from mine) and paste it into
your browser window. You should have a blank Jupyter notebook environment ready to go.</p><p><img loading="lazy" alt="Jupyter home screen" src="/assets/images/jupyter_home-2dc86f82e68de8e5f562af14a2352627.png" width="1226" height="377" class="img_ev3q"></p><p>Once your notebook environment is ready, click on the notebooks directory, then click on the New button to create a new
Python 3 notebook.</p><p><img loading="lazy" alt="Jupyter create new notebook" src="/assets/images/jupyter_new_notebook-615ec352aa7c69dc98d86b73fd5485e9.png" width="1214" height="365" class="img_ev3q"></p><p>In the first cell in the window paste the following text. Update the GCP project and bucket names and the
service account credentials file, then run the code:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sql </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SparkSession</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> urllib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># download dependencies for BigQuery and GCS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc_jars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;https://repo1.maven.org/maven2/com/google/cloud/bigdataoss/gcs-connector/hadoop3-2.1.1/gcs-connector-hadoop3-2.1.1-shaded.jar&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">&#x27;https://repo1.maven.org/maven2/com/google/cloud/bigdataoss/bigquery-connector/hadoop3-1.2.0/bigquery-connector-hadoop3-1.2.0-shaded.jar&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">&#x27;https://repo1.maven.org/maven2/com/google/cloud/spark/spark-bigquery-with-dependencies_2.12/0.22.2/spark-bigquery-with-dependencies_2.12-0.22.2.jar&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">urllib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">urlretrieve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> url </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> gc_jars</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set these to your own project and bucket</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bq-openlineage-spark-demo&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcs_bucket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bq-openlineage-spark-demo-bucket&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">credentials_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/home/jovyan/notebooks/gcs/bq-spark-demo.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SparkSession</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">master</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;local&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">appName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;openlineage_spark_test&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.jars&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">files</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># Install and set up the OpenLineage listener</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.jars.packages&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;io.openlineage:openlineage-spark:0.3.+&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.extraListeners&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;io.openlineage.spark.agent.OpenLineageSparkListener&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.openlineage.transport.url&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://marquez-api:5000&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.openlineage.transport.type&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.openlineage.namespace&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;spark_integration&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># Configure the Google credentials and project id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.executorEnv.GCS_PROJECT_ID&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> project_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.executorEnv.GOOGLE_APPLICATION_CREDENTIALS&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/home/jovyan/notebooks/gcs/bq-spark-demo.json&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.hadoop.google.cloud.auth.service.account.enable&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.hadoop.google.cloud.auth.service.account.json.keyfile&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> credentials_file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.hadoop.fs.gs.impl&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystem&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;spark.hadoop.fs.AbstractFileSystem.gs.impl&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;com.google.cloud.hadoop.fs.gcs.GoogleHadoopFS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;spark.hadoop.fs.gs.project.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> project_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrCreate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Most of this is boilerplate- we need the BigQuery and GCS libraries installed in the notebook environment, then we need
to set the configuration parameters to tell the libraries what GCP project we want to use and how to authenticate with
Google. The parameters specific to OpenLineage are the four we already covered- <code>spark.jars.packages</code>,
<code>spark.extraListeners</code>, <code>spark.openlineage.host</code>, <code>spark.openlineage.namespace</code>. Here, we’ve configured the host to be
the marquez-api container started by Docker.</p><p>Google has a wealth of information available as public datasets in BigQuery. If you’re ever bored one Saturday night,
browse the datasets available- you’ll find census data, crime data, liquor sales, and even a black hole database. For
the demo, I thought I’d browse some of the Covid19 related datasets they have. Specifically, there’s a dataset that
reports the likelihood of people in a given county to wear masks (broken up into five categories: <code>always</code>, <code>frequently</code>,
<code>sometimes</code>, <code>rarely</code>, and <code>never</code>). There’s also a giant dataset called <code>covid19_open_data</code> that contains things like
vaccination rates, current totals of confirmed cases, hospitalizations, deaths, population breakdowns, and policies on
mask-wearing, contact tracing, and vaccination-mandates. Both datasets contain the county FIPS code for US counties,
meaning we can join the two datasets and start exploring.</p><p>Create a new cell in the notebook and paste the following code:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sql</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">functions </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> col</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mask_use </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;bigquery&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;parentProject&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> project_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;table&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bigquery-public-data:covid19_nyt.mask_use_by_county&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;always + frequently&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;frequent&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;never + rarely&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;rare&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;county_fips_code&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opendata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;bigquery&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;parentProject&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> project_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;table&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bigquery-public-data.covid19_open_data.covid19_open_data&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;country_name == &#x27;United States of America&#x27;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;date == &#x27;2021-10-31&#x27;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;location_key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;cumulative_deceased/(population/100000)&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;deaths_per_100k&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;cumulative_persons_fully_vaccinated/(population - population_age_00_09)&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;vaccination_rate&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            col</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;subregion2_code&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;county_fips_code&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">joined </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mask_use</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opendata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;county_fips_code&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">joined</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;overwrite&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parquet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;gs://</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">gcs_bucket</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/demodata/covid_deaths_and_mask_usage/&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Again, this is standard Spark DataFrame usage. The particulars are completely irrelevant to the OpenLineage data
collection- we don’t need to call any new APIs or change our code in any way. Here, I’ve filtered
the <code>covid19_open_data</code> table to include only U.S. data and to include the data for Halloween 2021. That dataset has a
large number of columns, but for my own purposes, I’m only interested in a few of them. I calculate <code>deaths_per_100k</code>
using the existing <code>cumulative_deceased</code> and <code>population</code> columns and I calculate the <code>vaccination_rate</code> using the total
population, subtracting the 0-9 year olds, since they weren’t eligible for vaccination at the time. For
the <code>mask_use_by_county</code> data, I don&#x27;t really care about the difference between <code>rarely</code> and <code>never</code>, so I combine them
into a single number. I do the same for <code>frequently</code> and <code>always</code>. I join the few columns I want from the two datasets
and store the combined result in GCS.</p><p>Add one more cell to the notebook and paste the following:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parquet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;gs://</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">gcs_bucket</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/demodata/covid_deaths_and_mask_usage/&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The notebook will likely spit out a warning and a stacktrace (it should probably be a debug statement), then give you a
total of 3142 records.</p><p>So far, so good. Now what? If this was a data science blog, we might start generating some scatter plots or doing a
linear regression to determine whether frequent mask usage was a predictor of high death rates or vaccination rates.
But since we&#x27;re really focused on lineage collection, I&#x27;ll leave the rest of the analysis up to those with the time and
inclination to dig further. Instead, let&#x27;s switch to exploring the lineage records we just created.</p><p>The <code>docker-compose.yml</code> file that ships with the OpenLineage repo includes only the Jupyter notebook and the Marquez API.
For exploring visually, we’ll also want to start up the Marquez web project. Without terminating the existing docker
containers, run the following command in a new terminal:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run --network spark_default -p </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">:3000 -e </span><span class="token assign-left variable" style="color:#36acaa">MARQUEZ_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">marquez-api -e </span><span class="token assign-left variable" style="color:#36acaa">MARQUEZ_PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"> --link marquez-api:marquez-api marquezproject/marquez-web:0.19.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now open a new browser tab and navigate to <code>http://localhost:3000</code>. You should see a screen like the following:</p><p><img loading="lazy" alt="Marquez home page" src="/assets/images/marquez_home-a520b9086c3cb2d2d471bb97f5300c69.png" width="1688" height="1308" class="img_ev3q"></p><p>Note the spark_integration namespace was found for us and automatically chosen, since there are no other namespaces
available. We can see three jobs listed on the jobs page of the UI. They all start with <code>openlineage_spark_test</code>, which
is the <code>appName</code> we passed to the SparkSession we were building in the first cell of the notebook. Each query execution
or RDD action is represented as a distinct job and the name of the action is appended to the application name to form
the name of the job. Clicking on the <code>openlineage_spark_test.execute_insert_into_hadoop_fs_relation_command</code> node, we
can see the lineage graph for our notebook:</p><p><img loading="lazy" alt="Marquez job lineage" src="/assets/images/marquez_job_graph-737ca012d1735f9d01e32b806164f824.png" width="1687" height="1307" class="img_ev3q"></p><p>The graph shows the <code>openlineage_spark_test.execute_insert_into_hadoop_fs_relation_command</code> job reads from two input
datasets, <code>bigquery-public-data.covid19_nyt.mask_use_by_county</code>
and <code>bigquery-public-data.covid19_open_data.covid19_open_data</code>, and writes to a third dataset,
<code>/demodata/covid_deaths_and_mask_usage</code>. The namespace is missing from that third dataset- the fully qualified name is
<code>gs://&lt;your_bucket&gt;/demodata/covid_deaths_and_mask_usage</code>.</p><p>Before clicking on the datasets, though, the bottom bar shows some really interesting data that was collected from the
Spark job. Dragging the bar up expands the view so we can get a better look at that data.</p><p><img loading="lazy" alt="Marquez job facets" src="/assets/images/marquez_job_facets-cb90b68c176111b854130c8608daff7d.png" width="1687" height="1307" class="img_ev3q"></p><p>Two <a href="https://openlineage.io/blog/extending-with-facets/" target="_blank" rel="noopener noreferrer">facets</a> that are always collected from Spark jobs are
the <code>spark_version</code> and the <code>spark.logicalPlan</code>. The first simply reports what version of Spark was executing, as well
as the version of the <code>openlineage-spark</code> library. This is helpful information to collect when trying to debug a job
run.</p><p>The second facet is the serialized optimized <code>LogicalPlan</code> Spark reports when the job runs. Spark’s query optimization
can have dramatic effects on the execution time and efficiency of the query job. Tracking how query plans change over
time can significantly aid in debugging slow queries or OutOfMemory errors in production.</p><p>Clicking on the first BigQuery dataset gives us information about the data we read:</p><p><img loading="lazy" alt="Marquez dataset latest facet" src="/assets/images/marquez_bigquery_dataset_latest-ea115c38a4b88b4aad16f7c742d199ef.png" width="1686" height="1307" class="img_ev3q"></p><p>Here, we can see the schema of the dataset as well as the datasource — namely BigQuery.</p><p>We can get similar information about the dataset written to in GCS:</p><p><img loading="lazy" alt="Marquez output dataset latest facet" src="/assets/images/marquez_output_dataset_latest-16f47904a2fc669b208e409d9278ecf9.png" width="1688" height="1307" class="img_ev3q"></p><p>As in the BigQuery dataset, we can see the output schema and the datasource — here, the <code>gs://</code> scheme and the name of
the bucket we wrote to. </p><p>In addition to the schema, we also see a <code>stats</code> facet, reporting the number of output records and bytes as -1. A
somewhat recent change to the OpenLineage schema resulted in output facets being recorded in a new field- one that
Marquez is not yet reading from. The old, deprecated facet reports the output stats incorrectly. An upcoming bugfix
should correct the stats view so that we can see the number of rows written as well as the number of output bytes (the
statistics are actually recorded correctly- the API simply needs to start returning the correct values).</p><p>You may have noticed the <code>VERSIONS</code> tab on the bottom bar. We can click it, but since the job has only ever run once,
we’ll only see one version. Clicking on the version, we’ll see the same schema and statistics facets, but specific
to the version we clicked.</p><p><img loading="lazy" alt="Marquez output dataset version info" src="/assets/images/marquez_output_dataset_version-63ed3dec122baf4d59e4a66cf8a3b461.png" width="1687" height="1308" class="img_ev3q"></p><p>In production, this dataset would have many versions, as each time the job runs a new version of the dataset is created.
This allows us to track changes to the statistics and schema over time, again aiding in debugging slow jobs (suddenly,
we started writing 50% more records!) or data quality issues (suddenly, we’re only writing half as many records as
normal!) and job failures (somebody changed the output schema and downstream jobs are failing!).</p><p>The final job in the UI is a HashAggregate job- this represents the <code>count()</code> method we called at the end to show the
number of records in the dataset. Rather than a <code>count()</code>, this could easily be a <code>toPandas()</code> call or some other job
that reads and processes that data- perhaps storing output back into GCS or updating a Postgres database or publishing a
new model, etc. Regardless of where the output gets stored, the OpenLineage integration allows you to see the entire
lineage graph, unifying datasets in object stores, relational databases, and more traditional data warehouses.</p><p><a href="https://xkcd.com/2347/" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="XKCD 2347" src="/assets/images/dependency-b50296d079052156d1cfd4981de70a44.png" width="385" height="489" class="img_ev3q"></a></p><p>The Spark integration is still a work in progress, but users are already getting insights into their graphs of datasets
stored in object stores like S3, GCS, and Azure Blob Storage, as well as BigQuery and relational databases like
Postgres. Now with Spark 3.1 supported, we can gain visibility into more environments, like Databricks, EMR, and
Dataproc clusters.</p><p>Data lineage gives visibility to the (hopefully) high quality, (hopefully) regularly updated datasets that everyone
depends on, maybe without even realizing it. Spark helped usher in a welcome age of data democratization. Now data
observability can help ensure we’re making the best possible use of the data available.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/data-agility-day"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Video - OpenLineage at Data Agility Day</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/openlineage-at-northwestern-mutual"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">How Northwestern Mutual Simplified Data Observability with OpenLineage &amp; Marquez</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-age-of-data-democratization" class="table-of-contents__link toc-highlight">The Age of Data Democratization</a></li><li><a href="#a-colossal-mess" class="table-of-contents__link toc-highlight">A Colossal Mess</a></li><li><a href="#getting-started" class="table-of-contents__link toc-highlight">Getting Started</a></li><li><a href="#the-demo" class="table-of-contents__link toc-highlight">The Demo</a></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.53847bfe.js"></script>
<script src="/assets/js/main.3eff26fa.js"></script>
</body>
</html>