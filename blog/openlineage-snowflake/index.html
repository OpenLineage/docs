<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Data Lineage with Snowflake | OpenLineage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openlineage.io/blog/openlineage-snowflake"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Data Lineage with Snowflake | OpenLineage"><meta data-rh="true" name="description" content="The OpenLineage Adapter offers Snowflake&#x27;s enterprise users a powerful tool for analyzing their pipelines."><meta data-rh="true" property="og:description" content="The OpenLineage Adapter offers Snowflake&#x27;s enterprise users a powerful tool for analyzing their pipelines."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-04-27T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/merobi-hub"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openlineage.io/blog/openlineage-snowflake"><link data-rh="true" rel="alternate" href="https://openlineage.io/blog/openlineage-snowflake" hreflang="en"><link data-rh="true" rel="alternate" href="https://openlineage.io/blog/openlineage-snowflake" hreflang="x-default"><link rel="alternate" type="application/json" href="/blog/feed.json" title="OpenLineage JSON Feed">






<script src="https://plausible.io/js/script.js" defer="defer" data-domain="openlineage.io"></script><link rel="stylesheet" href="/assets/css/styles.f59d10a1.css">
<link rel="preload" href="/assets/js/runtime~main.39da8e11.js" as="script">
<link rel="preload" href="/assets/js/main.b859773a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#f26522;color:#091E42" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Help chart the course of OpenLineage! The 2023 Ecosystem Survey is live and accepting responses. <a href="https://forms.gle/cPk3skNgnB4iab9H6">Submit yours today</a>.</div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ol-logo.svg" alt="OpenLineage" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/resources">Resources</a><a class="navbar__item navbar__link" href="/ecosystem">Ecosystem</a><a class="navbar__item navbar__link" href="/community">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/OpenLineage/openlineage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/warsaw-meetup">Meet Us in Warsaw on November 29th!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/metaphor-integration">Metaphor&#x27;s Integration with OpenLineage Enhances Data Governance and Collaboration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/airflow-provider">The OpenLineage Airflow Provider is Here</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/airflow-summit-meetup">Meet Us in Toronto on September 18th!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/1.0-release">Announcing OpenLineage 1.0</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Data Lineage with Snowflake</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-04-27T00:00:00.000Z" itemprop="datePublished">April 27, 2022</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/merobi-hub" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/merobi-hub.png" alt="Michael Robinson"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/merobi-hub" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Michael Robinson</span></a></div><small class="avatar__subtitle" itemprop="description">OpenLineage Community Manager</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>The OpenLineage Adapter offers Snowflake&#x27;s enterprise users a powerful tool for analyzing their pipelines.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>We are excited to reveal a new way to gather lineage metadata directly from Snowflake: the OpenLineage Adapter. This integration offers Snowflake’s enterprise users a powerful tool for analyzing and diagnosing issues with their data pipelines.</p><p>This new integration will add new diagnostic capability to one of the world’s largest data platforms. Snowflake’s Data Cloud currently empowers more than 5,900 companies, including 241 of the Fortune 500 as of January 2022, to unite siloed data, securely share data, and execute diverse analytic workloads across their organizations. Legacy platforms struggled to provide a single, secure, and universally accessible platform for organizations to warehouse and analyze their data, but Snowflake’s Data Cloud provides a global ecosystem where customers, providers, and partners can finally break down data silos and derive value from rapidly growing data sets in secure, compliant, and governed ways.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2><p>An open source <a href="https://lfaidata.foundation/projects/openlineage" target="_blank" rel="noopener noreferrer">LF AI &amp; Data Foundation</a> sandbox project, OpenLineage provides an open standard for metadata and lineage collection that instruments jobs as they are running. OpenLineage not only automates the process of generating lineage and metadata about datasets, jobs, and runs in a data flow, but also does this in real time behind the scenes. With OpenLineage’s open standard and extensible backend, users can easily identify the root causes of slow or failing jobs and issues with data quality in their ecosystems without parsing queries. The magic of OpenLineage is its standard API for capturing lineage events. Any number of tools – from schedulers to SQL engines – can send metadata from this endpoint to a compatible tool such as <a href="https://github.com/MarquezProject/marquez" target="_blank" rel="noopener noreferrer">Marquez</a> for visualization and further analysis of a pipeline.</p><p>Historically, the process of producing lineage and collecting metadata has been laborious and error-prone. Extracting data from query logs via parsing, for example, required one to reimplement database parsing logic, which added complexity and introduced opportunities for user error. In addition, the lineage collected was incomplete. One could learn about the view that was queried but not about the underlying tables in the pipeline, much less about the upstream and downstream dependencies of the datasets. OpenLineage, by contrast, exploits what the database already knows and does to maintain an up-to-date, end-to-end graph of a pipeline – and makes the graph available via an API.     </p><p>OpenLineage and Snowflake play nicely because the latter is unusual among cloud data platforms for offering lineage information out of the box in a view (<a href="https://docs.snowflake.com/en/sql-reference/account-usage/access_history.html" target="_blank" rel="noopener noreferrer">ACCESS_HISTORY</a>). The integration of OpenLineage builds on this foundation to offer automated generation of lineage and metadata.</p><p>The value proposition of Snowflake + OpenLineage lies in the combination of an open standard tool, which supports multiple data systems to provide lineage in a single format, to Snowflake’s existing production of lineage information on an enterprise scale. The integration gives customers the ability to consume enterprise-wide table lineage and process lineage together in a consolidated OpenLineage format. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="approach">Approach<a href="#approach" class="hash-link" aria-label="Direct link to Approach" title="Direct link to Approach">​</a></h2><p>The process of integrating OpenLineage benefited from an existing query logging tool already available to Snowflake enterprise customers: the <code>ACCESS_HISTORY</code> view. As its name suggests, this feature, designed initially for governance use cases, offers users a detailed view of read operations conducted on Snowflake objects (e.g., tables, views, and columns) on an on-demand basis in response to SQL queries. (Write operations are viewable as a preview feature.)</p><p>As developed primarily by former Snowflake intern Aly Hirani with support from Datakin Senior Engineer Minkyu Park, the OpenLineage integration makes Access History the basis of automated production of lineage and metadata. But rather than produce a view for querying, OpenLineage produces a holistic lineage graph. To create the graph, the integration takes the data used to populate the Access History view and sends it to the OpenLineage backend as a standard OpenLineage event. Events in OpenLineage are JSON objects that employ a consistent naming strategy for database entities and enrich those entities with facets:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;eventType&quot;: &quot;COMPLETE&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;eventTime&quot;: &quot;2020-12-28T20:52:00.001+10:00&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;run&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;runId&quot;: &quot;d46e465b-d358-4d32-83d4-df660ff614dd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;job&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;namespace&quot;: &quot;my-namespace&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;name&quot;: &quot;my-job&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;outputs&quot;: [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;namespace&quot;: &quot;my-namespace&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;name&quot;: &quot;my-output&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;facets&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;schema&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;_producer&quot;: &quot;https://github.com/OpenLineage/OpenLineage/blob/v1-0-0/client&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;_schemaURL&quot;: &quot;https://github.com/OpenLineage/OpenLineage/blob/v1-0-0/spec/OpenLineage.json#/definitions/SchemaDatasetFacet&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;fields&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;name&quot;: &quot;a&quot;, &quot;type&quot;: &quot;VARCHAR&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { &quot;name&quot;: &quot;b&quot;, &quot;type&quot;: &quot;VARCHAR&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }],    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;producer&quot;: &quot;https://github.com/OpenLineage/OpenLineage/blob/v1-0-0/client&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-dag-based-solution">A DAG-based Solution<a href="#a-dag-based-solution" class="hash-link" aria-label="Direct link to A DAG-based Solution" title="Direct link to A DAG-based Solution">​</a></h2><p>Automating lineage production from the Access History view required a two-DAG solution. Minkyu had initially planned to use one DAG to scan the view and produce the lineage graph, but the timing of the logs used for the view precluded the production of lineage data with a single DAG. The solution Minkyu found was a separate DAG with a schedule for scanning the Access History view on a regular interval.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def send_ol_events():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   client = OpenLineageClient.from_environment()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   with connect(user=SNOWFLAKE_USER,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                password=SNOWFLAKE_PASSWORD,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                account=SNOWFLAKE_ACCOUNT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                database=&#x27;OPENLINEAGE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                schema=&#x27;PUBLIC&#x27;) as conn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       with conn.cursor() as cursor:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ol_view = &#x27;OPENLINEAGE_ACCESS_HISTORY&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ol_event_time_tag = &#x27;OL_LATEST_EVENT_TIME&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           var_query = f&#x27;&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               set current_organization=&#x27;{SNOWFLAKE_ACCOUNT}&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           &#x27;&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           cursor.execute(var_query)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ol_query = f&#x27;&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               SELECT * FROM {ol_view}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               WHERE EVENT:eventTime &gt; system$get_tag(&#x27;{ol_event_time_tag}&#x27;, &#x27;{ol_view}&#x27;, &#x27;table&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               ORDER BY EVENT:eventTime ASC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           &#x27;&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           cursor.execute(ol_query)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ol_events = [json.loads(ol_event[0]) for ol_event in cursor.fetchall()]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           for ol_event in ol_events:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               client.emit(ol_event)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           if len(ol_events) &gt; 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               latest_event_time = ol_events[-1][&#x27;eventTime&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               cursor.execute(f&#x27;&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   ALTER VIEW {ol_view} SET TAG {ol_event_time_tag} = &#x27;{latest_event_time}&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               &#x27;&#x27;&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_args = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;owner&#x27;: &#x27;openlineage&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;depends_on_past&#x27;: False,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;start_date&#x27;: days_ago(1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;email_on_failure&#x27;: False,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;email_on_retry&#x27;: False,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;email&#x27;: [&#x27;demo@openlineage.io&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;snowflake_conn_id&#x27;: &#x27;openlineage_snowflake&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">with DAG(&#x27;etl_openlineage&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schedule_interval=&#x27;@hourly&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catchup=False,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default_args=default_args,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description=&#x27;Send OL events every minutes&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags=[&quot;extract&quot;]) as dag:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t1 = PythonOperator(task_id=&#x27;ol_event&#x27;, python_callable=send_ol_events)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started-with-an-example">Getting Started with an Example<a href="#getting-started-with-an-example" class="hash-link" aria-label="Direct link to Getting Started with an Example" title="Direct link to Getting Started with an Example">​</a></h2><p>This example uses Airflow to run a collection of Snowflake queries for a fictional food delivery service. Lineage data for these queries will be recorded within Snowflake <code>ACCESS_HISTORY</code> and, using the OpenLineage Access History View, emitted to an OpenLineage backend.</p><p>This is done using a series of DAGs in <code>dags/etl</code> that each use SnowflakeOperator to run queries, along with a DAG in <code>dags/lineage</code> that uses PythonOperator to send generated OpenLineage events to the configured backend.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="installing-marquez">Installing Marquez<a href="#installing-marquez" class="hash-link" aria-label="Direct link to Installing Marquez" title="Direct link to Installing Marquez">​</a></h4><p>First, checkout the Marquez repository:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/MarquezProject/marquez.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token builtin class-name">cd</span><span class="token plain"> marquez</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, run Marquez in detached mode:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% docker/up.sh -d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="preparing-snowflake">Preparing Snowflake<a href="#preparing-snowflake" class="hash-link" aria-label="Direct link to Preparing Snowflake" title="Direct link to Preparing Snowflake">​</a></h4><p>First, check out the OpenLineage Access History View repository:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/Snowflake-Labs/OpenLineage-AccessHistory-Setup.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token builtin class-name">cd</span><span class="token plain"> OpenLineage-AccessHistory-Setup</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>OPENLINEAGE</code> database and <code>FOOD_DELIVERY</code> schema in Snowflake need to be created. This can be done using the SnowSQL command-line tool, or by pasting the queries into a new Snowflake Worksheet. This example uses SnowSQL.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% snowsql -u </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">snowflake-user</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -a </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">snowflake-account</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> CREATE DATABASE OPENLINEAGE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> CREATE SCHEMA OPENLINEAGE.FOOD_DELIVERY</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The view defined in <code>open_lineage_access_history.sql</code> also needs to be created. This view represents the entries in <code>ACCESS_HISTORY</code> as specially-constructed JSON objects containing RunEvents that can be emitted to an OpenLineage backend. To create it, use SnowSQL to set the current_organization session variable and execute the SQL file.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL&gt; SET current_organization=&#x27;&lt;snowflake-organization&gt;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL&gt; USE SCHEMA OPENLINEAGE.PUBLIC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL&gt; !source open_lineage_access_history.sql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, our lineage extraction DAG relies upon a tag on the view to keep track of which lineage events have been processed. This tag needs to be initialized:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL&gt; CREATE TAG OL_LATEST_EVENT_TIME;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL&gt; ALTER VIEW OPENLINEAGE.PUBLIC.OPENLINEAGE_ACCESS_HISTORY SET TAG OL_LATEST_EVENT_TIME = &#x27;1970-01-01T00:00:00.000&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SnowSQL&gt; !quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="preparing-the-environment">Preparing the Environment<a href="#preparing-the-environment" class="hash-link" aria-label="Direct link to Preparing the Environment" title="Direct link to Preparing the Environment">​</a></h3><p>The following environment variables need to be set in order for the query DAGs to connect to Snowflake, and so that the extraction DAG can send lineage events to your OpenLineage backend:</p><ul><li>SNOWFLAKE_USER</li><li>SNOWFLAKE_PASSWORD</li><li>SNOWFLAKE_ACCOUNT</li><li>OPENLINEAGE_URL</li><li>AIRFLOW_CONN_OPENLINEAGE_SNOWFLAKE</li></ul><p>To do this, copy the <code>.env-example</code> file to <code>.env</code>, and edit it to provide the appropriate values for your environment. The variables in this file will be set for each service in the Airflow deployment.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token builtin class-name">cd</span><span class="token plain"> examples/airflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> .env-example .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="preparing-airflow">Preparing Airflow<a href="#preparing-airflow" class="hash-link" aria-label="Direct link to Preparing Airflow" title="Direct link to Preparing Airflow">​</a></h3><p>Once the environment is prepared, initialize Airflow with docker-compose:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token function" style="color:#d73a49">docker-compose</span><span class="token plain"> up airflow-init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will take several minutes. When it has finished, bring up the Airflow services:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% docker-compose up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will also take several minutes. Eventually, the webserver will be up at <a href="http://localhost:8080" target="_blank" rel="noopener noreferrer">http://localhost:8080</a>. Log in using the default credentials (airflow/airflow) and navigate to the DAGs page. When you see 12 DAGs in the list, you can be confident that Airflow has completed its initialization of the example.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-example">Running the Example<a href="#running-the-example" class="hash-link" aria-label="Direct link to Running the Example" title="Direct link to Running the Example">​</a></h3><p>Each of the DAGs is paused by default. Enable each one, skipping the <code>etl_openlineage</code> DAG for now. They may not all run successfully on the first try, since they have interdependencies that this example leaves unmanaged.</p><p><img loading="lazy" alt="Airflow DAG list" src="/assets/images/snowflake-airflow-example-e7bd5af6f0f7db54096dd1c996e06a67.png" width="2674" height="1404" class="img_ev3q"></p><p>After each DAG has completed at least one successful run, enable <code>etl_openlineage</code>. Wait for it to complete its run.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p>Navigate to your Marquez deployment and view the resulting lineage graph:</p><p><img loading="lazy" alt="Lineage graph" src="/assets/images/snowflake-openlineage-example-8802743d7b8dd89e7d0b711e64308bb9.png" width="1328" height="682" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="potential-improvements">Potential Improvements<a href="#potential-improvements" class="hash-link" aria-label="Direct link to Potential Improvements" title="Direct link to Potential Improvements">​</a></h2><p>This new integration paves the way for an exciting set of potential future capabilities. These include support for <code>Object_Dependencies</code> and the addition of Granular Lineage (column-level lineage). We are interested in feedback from users, which will help the team at Snowflake and the members of the OpenLineage community prioritize future work.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>Snowflake’s integration of the OpenLineage standard promises to dramatically improve enterprise users’ ability to diagnose issues with quality and performance in their pipelines. This project is cause for optimism about future collaboration with OpenLineage. The fit between Snowflake’s enterprise product and OpenLineage is already fairly seamless. Further collaboration would likely yield additional features and, by extension, more value for Snowflake’s customers. Also, the fact that OpenLineage is an open standard offers opportunities for fruitful integrations with other partners. Supporters of OpenLineage already include Spark, Airflow, and dbt, and the list is growing. For more information or to contribute to OpenLineage, reach out on <a href="https://twitter.com/OpenLineage/" target="_blank" rel="noopener noreferrer">twitter</a> or <a href="https://join.slack.com/t/openlineage/shared_invite/zt-oko79982-4bHHhxTUDQ9KXgQWXyWVxg" target="_blank" rel="noopener noreferrer">Slack</a>, and check out the repositories on <a href="https://github.com/OpenLineage/" target="_blank" rel="noopener noreferrer">Github</a>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/openlineage-microsoft-purview"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Microsoft Purview Accelerates Lineage Extraction from Azure Databricks</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/openlineage-egeria"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">OpenLineage Support in Egeria</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#approach" class="table-of-contents__link toc-highlight">Approach</a></li><li><a href="#a-dag-based-solution" class="table-of-contents__link toc-highlight">A DAG-based Solution</a></li><li><a href="#getting-started-with-an-example" class="table-of-contents__link toc-highlight">Getting Started with an Example</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#preparing-the-environment" class="table-of-contents__link toc-highlight">Preparing the Environment</a></li><li><a href="#preparing-airflow" class="table-of-contents__link toc-highlight">Preparing Airflow</a></li><li><a href="#running-the-example" class="table-of-contents__link toc-highlight">Running the Example</a></li><li><a href="#result" class="table-of-contents__link toc-highlight">Result</a></li></ul></li><li><a href="#potential-improvements" class="table-of-contents__link toc-highlight">Potential Improvements</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.39da8e11.js"></script>
<script src="/assets/js/main.b859773a.js"></script>
</body>
</html>